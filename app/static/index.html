<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Satellite Scanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @keyframes pulse-bg { 0%,100%{opacity:1} 50%{opacity:.6} }
  .pulse-badge { animation: pulse-bg 1.5s ease-in-out infinite; }
  .sort-asc::after { content: ' \u25B2'; font-size: .65em; }
  .sort-desc::after { content: ' \u25BC'; font-size: .65em; }
  .toast{animation:slideIn .3s ease}
  @keyframes slideIn{from{transform:translateY(-1rem);opacity:0}to{transform:translateY(0);opacity:1}}
  .nav-item{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;transition:all .15s;cursor:pointer;color:#9ca3af}
  .nav-item:hover{background:#1f2937;color:#e5e7eb}
  .nav-item.active{background:#1d4ed8;color:#fff}
</style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex">

<!-- Toast container -->
<div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Sidebar -->
<aside class="w-56 bg-gray-900 border-r border-gray-800 flex flex-col min-h-screen shrink-0">
  <!-- Logo -->
  <div class="px-4 py-5 border-b border-gray-800">
    <h1 class="text-lg font-bold tracking-tight">Satellite Scanner</h1>
  </div>

  <!-- Navigation -->
  <nav class="flex-1 px-3 py-4 space-y-1">
    <a class="nav-item" data-page="scans" href="#scans">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      Scans
    </a>
    <a class="nav-item" data-page="settings" href="#settings">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      Settings
    </a>
  </nav>

  <!-- Health status at bottom -->
  <div class="px-4 py-3 border-t border-gray-800">
    <div id="health-badge" class="flex items-center gap-2 text-xs text-gray-400">
      <span class="w-2 h-2 rounded-full bg-green-500 shrink-0"></span>
      <span>Healthy</span>
      <span class="text-gray-600">Queue: <span id="queue-size">0</span></span>
    </div>
  </div>
</aside>

<!-- Main content -->
<div class="flex-1 flex flex-col min-h-screen overflow-hidden">

  <!-- ==================== SCANS PAGE ==================== -->
  <div id="page-scans" class="page flex-1 flex flex-col overflow-hidden">

    <!-- Top bar: scan form + page header -->
    <div class="border-b border-gray-800 bg-gray-900/50 px-6 py-4">
      <div class="flex items-start gap-6">
        <!-- New Scan form (inline) -->
        <form id="scan-form" class="space-y-3 max-w-lg">
          <div class="flex items-end gap-3">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Facility Name</label>
              <input id="sf-name" type="text" placeholder="Amerequip Corporation" required
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
          </div>
          <div class="flex items-end gap-2">
            <div class="flex-1">
              <label class="block text-xs text-gray-500 mb-1">Address / Location</label>
              <input id="sf-location" type="text" placeholder="123 Main St, City, ST  or  Google Maps URL  or  41.05, -80.67" required
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <button id="sf-resolve" type="button"
              class="bg-gray-700 hover:bg-gray-600 text-white font-medium rounded px-4 py-1.5 text-sm transition whitespace-nowrap">
              Resolve
            </button>
          </div>
          <!-- Resolve result area -->
          <div id="sf-resolve-result" class="hidden">
            <!-- Filled dynamically by JS -->
          </div>
          <!-- Manual override inputs (hidden by default) -->
          <div id="sf-manual-override" class="hidden flex items-end gap-3">
            <div>
              <label class="block text-xs text-gray-500 mb-1">Latitude</label>
              <input id="sf-lat" type="number" step="any" placeholder="41.0534"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-32 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-1">Longitude</label>
              <input id="sf-lng" type="number" step="any" placeholder="-80.6753"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-32 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <button type="button" onclick="applyManualCoords()" class="bg-gray-700 hover:bg-gray-600 text-white font-medium rounded px-3 py-1.5 text-sm transition">Apply</button>
            <button type="button" onclick="cancelManualOverride()" class="text-gray-500 hover:text-gray-300 text-sm transition">Cancel</button>
          </div>
          <button id="sf-submit" type="submit" disabled
            class="bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium rounded px-4 py-1.5 text-sm transition whitespace-nowrap">
            Submit Scan
          </button>
        </form>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="px-6 py-3 flex flex-wrap items-center gap-3 border-b border-gray-800/50">
      <input id="search-input" type="text" placeholder="Search facility name..."
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-56 focus:ring-1 focus:ring-blue-500 outline-none">
      <select id="filter-status"
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
        <option value="">All Statuses</option>
        <option value="queued">Queued</option>
        <option value="running_osm">Running OSM</option>
        <option value="running_validate">Running Validate</option>
        <option value="running_vision">Running Vision</option>
        <option value="running_tiling">Running Tiling</option>
        <option value="completed">Completed</option>
        <option value="failed">Failed</option>
        <option value="skipped">Skipped</option>
      </select>
      <select id="filter-method"
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
        <option value="">All Methods</option>
        <option value="osm_building">OSM Building</option>
        <option value="osm_landuse">OSM Landuse</option>
        <option value="ai_vision">AI Vision</option>
        <option value="fallback_radius">Fallback Radius</option>
        <option value="skipped">Skipped</option>
      </select>
      <button id="refresh-btn" title="Refresh"
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 rounded px-3 py-1.5 text-sm transition">
        &#8635; Refresh
      </button>
      <span id="scan-count" class="text-sm text-gray-500 ml-auto">0 scans</span>
      <button id="delete-btn" disabled
        class="bg-red-700 hover:bg-red-600 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium rounded px-3 py-1.5 text-sm transition hidden">
        Delete Selected (<span id="delete-count">0</span>)
      </button>
    </div>

    <!-- Table (scrollable) -->
    <div class="flex-1 overflow-auto px-6 py-4">
      <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-gray-900 z-10">
            <tr class="border-b border-gray-800 text-gray-400 text-left">
              <th class="px-3 py-2.5 w-8"><input id="select-all" type="checkbox" class="rounded bg-gray-800 border-gray-600 cursor-pointer"></th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="index">#</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="facility_name">Facility</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="status">Status</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="method">Method</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="ai_validated">AI</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="ai_facility_type">Type</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="bbox">BBox</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="duration">Duration</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="started_at">Date</th>
            </tr>
          </thead>
          <tbody id="scan-tbody"></tbody>
        </table>
        <!-- Empty state -->
        <div id="empty-state" class="hidden text-center py-12 text-gray-500">
          No scans found. Submit a facility above to get started.
        </div>
        <!-- Loading state -->
        <div id="loading-state" class="text-center py-12 text-gray-500">
          Loading scans...
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-3 border-t border-gray-800 flex items-center justify-between shrink-0">
      <button id="prev-btn" disabled
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed rounded px-4 py-1.5 text-sm transition">
        &larr; Prev
      </button>
      <span id="page-info" class="text-sm text-gray-500"></span>
      <button id="next-btn" disabled
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 disabled:opacity-40 disabled:cursor-not-allowed rounded px-4 py-1.5 text-sm transition">
        Next &rarr;
      </button>
    </div>
  </div>

  <!-- ==================== SETTINGS PAGE ==================== -->
  <div id="page-settings" class="page hidden flex-1 overflow-auto">
    <div class="px-6 py-6 max-w-3xl">
      <h2 class="text-xl font-bold mb-1">Settings</h2>
      <p class="text-sm text-gray-500 mb-6">Configure API keys, AI models, and scan defaults.</p>

      <form id="settings-form" class="space-y-6">
        <!-- API Key -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">API Configuration</h3>
          <div>
            <label class="block text-sm text-gray-300 mb-1.5">OpenAI API Key</label>
            <input id="set-api-key" type="password" placeholder="sk-..."
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none max-w-md">
            <p class="text-xs text-gray-600 mt-1">Leave blank to keep current key. Current: <span id="set-api-key-mask" class="text-gray-500">not set</span></p>
          </div>
        </div>

        <!-- Models -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">AI Models</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Validation Model</label>
              <input id="set-validation-model" type="text" placeholder="gpt-4o-mini"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Used for OSM bbox validation (step 2)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Boundary Model</label>
              <input id="set-boundary-model" type="text" placeholder="gpt-4o"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Used for AI vision fallback (step 3)</p>
            </div>
          </div>
        </div>

        <!-- Scan Defaults -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">Scan Defaults</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Default Zoom</label>
              <input id="set-default-zoom" type="number" min="16" max="22"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Tile zoom for detail (16–22)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Buffer (meters)</label>
              <input id="set-buffer" type="number" min="10" max="500"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Padding around OSM bbox (10–500)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Overview Zoom</label>
              <input id="set-overview-zoom" type="number" min="16" max="21"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Zoom for AI validation images (16–21)</p>
            </div>
          </div>
        </div>

        <!-- AI Prompts -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">AI Prompts</h3>
          <div>
            <label class="block text-sm text-gray-300 mb-1.5">Validation Prompt</label>
            <textarea id="set-validation-prompt" rows="6" placeholder="Leave blank to use default"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with the overview image during OSM bbox validation (step 2). Supports {name}, {lat}, {lng}, {width_m}, {height_m} placeholders.</p>
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1.5">Boundary Detection Prompt</label>
            <textarea id="set-boundary-prompt" rows="10" placeholder="Leave blank to use default"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with the satellite image for facility boundary identification (step 3). Image context is appended automatically.</p>
          </div>
        </div>

        <!-- Save -->
        <div class="flex items-center gap-3">
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium rounded px-5 py-2 text-sm transition">
            Save Settings
          </button>
          <span id="settings-status" class="text-sm text-gray-500"></span>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
// --- State ---
const S = {
  scans: [],
  sortField: null,
  sortDir: 'asc',
  offset: 0,
  limit: 50,
  expanded: {},
  expandedOpen: {},
  selected: new Set(),
  pollTimer: null,
  currentPage: 'scans',
  // Geocoding resolved state
  resolved: null, // { lat, lng, display_name, source }
};

// --- Router ---
function navigate(page) {
  S.currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  const target = document.getElementById(`page-${page}`);
  if (target) target.classList.remove('hidden');

  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.page === page);
  });

  if (page === 'settings') loadSettings();
  if (page === 'scans') fetchScans();
}

function handleHash() {
  const hash = location.hash.replace('#', '') || 'scans';
  navigate(hash);
}

// --- API helper ---
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: res.statusText }));
    throw new Error(err.detail || JSON.stringify(err));
  }
  return res.status === 204 ? null : res.json();
}

// --- Toast ---
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  const colors = type === 'success' ? 'bg-green-600' : 'bg-red-600';
  el.className = `toast ${colors} text-white text-sm px-4 py-2 rounded shadow-lg max-w-sm`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// --- Status badge ---
function statusBadge(status) {
  const map = {
    queued: 'bg-gray-600 text-gray-100',
    running_osm: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_validate: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_vision: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_tiling: 'bg-yellow-600 text-yellow-100 pulse-badge',
    completed: 'bg-green-700 text-green-100',
    failed: 'bg-red-700 text-red-100',
    skipped: 'bg-blue-700 text-blue-100',
  };
  const cls = map[status] || 'bg-gray-600 text-gray-100';
  const label = (status || '').replace(/_/g, ' ');
  return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${cls}">${label}</span>`;
}

// --- Format helpers ---
function fmtDuration(scan) {
  if (!scan.started_at || !scan.completed_at) return '-';
  const ms = new Date(scan.completed_at) - new Date(scan.started_at);
  return ms < 1000 ? `${ms}ms` : `${(ms / 1000).toFixed(1)}s`;
}

function fmtDate(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
    d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function fmtBbox(scan) {
  if (scan.bbox_width_m == null || scan.bbox_height_m == null) return '-';
  return `${Math.round(scan.bbox_width_m)}x${Math.round(scan.bbox_height_m)}m`;
}

function fmtAI(scan) {
  if (scan.ai_validated === true) return '<span class="text-green-400 font-bold">&#10003;</span>';
  if (scan.ai_validated === false) return '<span class="text-red-400 font-bold">&#10007;</span>';
  return '<span class="text-gray-600">-</span>';
}

function fmtMethod(m) {
  if (!m) return '-';
  return m.replace(/_/g, ' ');
}

// --- Sorting ---
function getSortValue(scan, field, idx) {
  switch (field) {
    case 'index': return idx;
    case 'facility_name': return (scan.facility_name || '').toLowerCase();
    case 'status': return scan.status || '';
    case 'method': return scan.method || '';
    case 'ai_validated': return scan.ai_validated === true ? 2 : scan.ai_validated === false ? 1 : 0;
    case 'ai_facility_type': return (scan.ai_facility_type || '').toLowerCase();
    case 'bbox': return (scan.bbox_width_m || 0) * (scan.bbox_height_m || 0);
    case 'duration': {
      if (!scan.started_at || !scan.completed_at) return 0;
      return new Date(scan.completed_at) - new Date(scan.started_at);
    }
    case 'started_at': return scan.started_at ? new Date(scan.started_at).getTime() : 0;
    default: return '';
  }
}

function sortScans(scans) {
  if (!S.sortField) return scans;
  const sorted = scans.map((s, i) => ({ s, i }));
  sorted.sort((a, b) => {
    const va = getSortValue(a.s, S.sortField, a.i);
    const vb = getSortValue(b.s, S.sortField, b.i);
    let cmp = 0;
    if (typeof va === 'number' && typeof vb === 'number') cmp = va - vb;
    else cmp = String(va).localeCompare(String(vb));
    return S.sortDir === 'asc' ? cmp : -cmp;
  });
  return sorted.map(x => x.s);
}

// --- Render table ---
function renderTable() {
  const tbody = document.getElementById('scan-tbody');
  const empty = document.getElementById('empty-state');
  const loading = document.getElementById('loading-state');
  loading.classList.add('hidden');

  const sorted = sortScans(S.scans);

  if (sorted.length === 0) {
    tbody.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  let html = '';
  sorted.forEach((scan, i) => {
    const rowNum = S.offset + i + 1;
    const isOpen = S.expandedOpen[scan.id];
    const checked = S.selected.has(scan.id) ? 'checked' : '';
    html += `<tr class="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer transition" data-id="${scan.id}">
      <td class="px-3 py-2" onclick="event.stopPropagation()"><input type="checkbox" class="row-check rounded bg-gray-800 border-gray-600 cursor-pointer" data-id="${scan.id}" ${checked}></td>
      <td class="px-3 py-2 text-gray-500">${rowNum}</td>
      <td class="px-3 py-2 font-medium">${esc(scan.facility_name || '-')}</td>
      <td class="px-3 py-2">${statusBadge(scan.status)}</td>
      <td class="px-3 py-2 text-gray-400">${fmtMethod(scan.method)}</td>
      <td class="px-3 py-2 text-center">${fmtAI(scan)}</td>
      <td class="px-3 py-2 text-gray-400">${esc(scan.ai_facility_type || '-')}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${fmtBbox(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${fmtDuration(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${fmtDate(scan.started_at)}</td>
    </tr>`;
    if (isOpen) {
      html += `<tr class="border-b border-gray-800 bg-gray-800/30"><td colspan="10" class="px-4 py-3">`;
      html += renderDetail(scan);
      html += `</td></tr>`;
    }
  });
  tbody.innerHTML = html;

  tbody.querySelectorAll('tr[data-id]').forEach(row => {
    row.addEventListener('click', () => toggleRow(row.dataset.id));
  });

  // Checkbox handlers
  tbody.querySelectorAll('.row-check').forEach(cb => {
    cb.addEventListener('change', () => {
      if (cb.checked) S.selected.add(cb.dataset.id);
      else S.selected.delete(cb.dataset.id);
      updateDeleteBtn();
    });
  });

  // Sync select-all state
  const selectAll = document.getElementById('select-all');
  if (selectAll) {
    selectAll.checked = sorted.length > 0 && sorted.every(s => S.selected.has(s.id));
    selectAll.indeterminate = sorted.some(s => S.selected.has(s.id)) && !selectAll.checked;
  }

  document.getElementById('scan-count').textContent = `${sorted.length} scan${sorted.length !== 1 ? 's' : ''}`;

  document.getElementById('prev-btn').disabled = S.offset === 0;
  document.getElementById('next-btn').disabled = sorted.length < S.limit;
  const page = Math.floor(S.offset / S.limit) + 1;
  document.getElementById('page-info').textContent = `Page ${page}`;
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

// --- Detail panel ---
function renderDetail(scan) {
  const trace = S.expanded[scan.id];
  let html = '<div class="space-y-4">';

  if (scan.screenshots && scan.screenshots.length > 0) {
    html += '<div class="flex flex-wrap gap-3">';
    scan.screenshots.forEach(ss => {
      const sizeParts = [];
      if (ss.width && ss.height) sizeParts.push(`${ss.width}×${ss.height}px`);
      if (ss.file_size_bytes) sizeParts.push(`${(ss.file_size_bytes / 1048576).toFixed(2)} MB`);
      const sizeStr = sizeParts.length ? ` — ${sizeParts.join(', ')}` : '';
      html += `<div class="text-center">
        <a href="${ss.url}" target="_blank" rel="noopener" title="Open full screenshot">
          <img src="${ss.url}" alt="${esc(ss.type)}" class="rounded border border-gray-700 max-h-48 object-contain cursor-pointer hover:border-blue-500 transition-colors" loading="lazy">
        </a>
        <div class="text-xs text-gray-500 mt-1">${esc(ss.type)} (z${ss.zoom || '?'})${sizeStr}</div>
      </div>`;
    });
    html += '</div>';
  }

  if (trace && trace.steps) {
    html += '<div class="space-y-2">';
    html += '<h4 class="text-xs font-semibold uppercase tracking-wide text-gray-400">Pipeline Trace</h4>';
    trace.steps.forEach(step => {
      const dur = step.duration_ms != null ? `(${(step.duration_ms / 1000).toFixed(1)}s)` : '';
      const dec = step.decision || '';
      const stepColor = step.status === 'failed' ? 'text-red-400' : 'text-green-400';
      html += `<div class="bg-gray-900 rounded px-3 py-2 text-sm">
        <span class="text-gray-500">Step ${step.step_number}:</span>
        <span class="font-medium">${esc(step.step_name.replace(/_/g, ' '))}</span>
        <span class="text-gray-500">${dur}</span>
        <span class="${stepColor}"> &rarr; ${esc(dec)}</span>`;

      if (step.ai_tokens_total) {
        html += `<div class="text-xs text-gray-500 mt-1 ml-4">
          Model: <span class="text-gray-300">${esc(step.ai_model || '?')}</span> |
          Tokens: <span class="text-gray-300">${step.ai_tokens_total.toLocaleString()}</span>
          (${(step.ai_tokens_prompt || 0).toLocaleString()}p + ${(step.ai_tokens_completion || 0).toLocaleString()}c${step.ai_tokens_reasoning ? ' + ' + step.ai_tokens_reasoning.toLocaleString() + 'r' : ''})
        </div>`;
      }

      if (step.tile_grid_cols && step.tile_grid_rows) {
        const total = step.tile_grid_cols * step.tile_grid_rows;
        html += `<div class="text-xs text-gray-500 mt-1 ml-4">
          Grid: ${step.tile_grid_cols}x${step.tile_grid_rows} = ${total} tiles
        </div>`;
      }

      html += '</div>';
    });

    if (trace.total_ai_tokens) {
      html += `<div class="text-xs text-gray-400 mt-1">Total AI tokens: <span class="text-gray-200 font-medium">${trace.total_ai_tokens.toLocaleString()}</span></div>`;
    }
    html += '</div>';
  } else if (!trace) {
    html += '<div class="text-sm text-gray-500">Loading trace...</div>';
  }

  html += '<details class="text-xs"><summary class="text-gray-500 cursor-pointer hover:text-gray-300">Full Metadata</summary>';
  html += `<pre class="mt-2 bg-gray-950 rounded p-3 overflow-x-auto text-gray-400 max-h-64">${esc(JSON.stringify(scan, null, 2))}</pre>`;
  html += '</details>';

  html += '</div>';
  return html;
}

// --- Row expand/collapse ---
async function toggleRow(scanId) {
  if (S.expandedOpen[scanId]) {
    S.expandedOpen[scanId] = false;
    renderTable();
    return;
  }

  S.expandedOpen[scanId] = true;

  if (!S.expanded[scanId]) {
    renderTable();
    try {
      const trace = await api('GET', `/api/scan/${scanId}/steps`);
      S.expanded[scanId] = trace;
    } catch (e) {
      S.expanded[scanId] = { steps: [], error: e.message };
    }
  }
  renderTable();
}

// --- Selection / Delete ---
function updateDeleteBtn() {
  const btn = document.getElementById('delete-btn');
  const count = S.selected.size;
  document.getElementById('delete-count').textContent = count;
  btn.disabled = count === 0;
  btn.classList.toggle('hidden', count === 0);
}

async function deleteSelected() {
  const ids = [...S.selected];
  if (ids.length === 0) return;
  if (!confirm(`Delete ${ids.length} scan${ids.length > 1 ? 's' : ''}? This cannot be undone.`)) return;

  const btn = document.getElementById('delete-btn');
  btn.disabled = true;
  btn.textContent = 'Deleting...';

  try {
    const res = await api('DELETE', '/api/scans', { scan_ids: ids });
    toast(`Deleted ${res.deleted} scan${res.deleted !== 1 ? 's' : ''}`);
    S.selected.clear();
    updateDeleteBtn();
    fetchScans();
    fetchHealth();
  } catch (e) {
    toast('Delete failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Delete Selected (<span id="delete-count">0</span>)';
    updateDeleteBtn();
  }
}

// --- Fetch scans ---
async function fetchScans() {
  const params = new URLSearchParams();
  const status = document.getElementById('filter-status').value;
  const method = document.getElementById('filter-method').value;
  const search = document.getElementById('search-input').value.trim();

  if (status) params.set('status', status);
  if (method) params.set('method', method);
  if (search) params.set('search', search);
  params.set('limit', S.limit);
  params.set('offset', S.offset);

  try {
    S.scans = await api('GET', `/api/scans?${params}`);
    renderTable();
    managePoll();
  } catch (e) {
    toast('Failed to load scans: ' + e.message, 'error');
  }
}

// --- Polling ---
const TERMINAL = new Set(['completed', 'failed', 'skipped']);

function managePoll() {
  const hasActive = S.scans.some(s => !TERMINAL.has(s.status));
  if (hasActive && !S.pollTimer) {
    S.pollTimer = setInterval(fetchScans, 5000);
  } else if (!hasActive && S.pollTimer) {
    clearInterval(S.pollTimer);
    S.pollTimer = null;
  }
}

// --- Health check ---
async function fetchHealth() {
  try {
    const h = await api('GET', '/health');
    document.getElementById('queue-size').textContent = h.queue_size;
  } catch {}
}

// --- Settings ---
async function loadSettings() {
  try {
    const s = await api('GET', '/api/settings');
    document.getElementById('set-api-key').value = '';
    document.getElementById('set-api-key-mask').textContent = s.openai_api_key || 'not set';
    document.getElementById('set-validation-model').value = s.validation_model || '';
    document.getElementById('set-boundary-model').value = s.boundary_model || '';
    document.getElementById('set-default-zoom').value = s.default_zoom || '';
    document.getElementById('set-buffer').value = s.default_buffer_m || '';
    document.getElementById('set-overview-zoom').value = s.overview_zoom || '';
    document.getElementById('set-validation-prompt').value = s.validation_prompt || '';
    document.getElementById('set-boundary-prompt').value = s.boundary_prompt || '';
  } catch {}
}

async function saveSettings(e) {
  e.preventDefault();
  const body = {};
  const key = document.getElementById('set-api-key').value.trim();
  if (key) body.openai_api_key = key;
  const vm = document.getElementById('set-validation-model').value.trim();
  if (vm) body.validation_model = vm;
  const bm = document.getElementById('set-boundary-model').value.trim();
  if (bm) body.boundary_model = bm;
  const dz = document.getElementById('set-default-zoom').value.trim();
  if (dz) body.default_zoom = dz;
  const buf = document.getElementById('set-buffer').value.trim();
  if (buf) body.default_buffer_m = buf;
  const oz = document.getElementById('set-overview-zoom').value.trim();
  if (oz) body.overview_zoom = oz;
  const vp = document.getElementById('set-validation-prompt').value.trim();
  if (vp) body.validation_prompt = vp;
  const bp = document.getElementById('set-boundary-prompt').value.trim();
  if (bp) body.boundary_prompt = bp;

  if (Object.keys(body).length === 0) {
    toast('No changes to save', 'error');
    return;
  }

  try {
    await api('PUT', '/api/settings', body);
    toast('Settings saved');
    loadSettings();
  } catch (e) {
    toast('Failed: ' + e.message, 'error');
  }
}

// --- Geocoding ---
function parseGoogleMapsUrl(str) {
  const match = str.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (!match) return null;
  const lat = parseFloat(match[1]);
  const lng = parseFloat(match[2]);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
  return { lat, lng };
}

function parseRawCoords(str) {
  const match = str.trim().match(/^(-?\d+\.?\d*)\s*[,\s]\s*(-?\d+\.?\d*)$/);
  if (!match) return null;
  const lat = parseFloat(match[1]);
  const lng = parseFloat(match[2]);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
  return { lat, lng };
}

async function geocodeCensus(str) {
  const res = await fetch(`/api/geocode/census?address=${encodeURIComponent(str)}`);
  if (!res.ok) throw new Error(`Census Geocoder returned ${res.status}`);
  const data = await res.json();
  const matches = data?.result?.addressMatches;
  if (!matches || matches.length === 0) throw new Error('No results found for this address');
  const m = matches[0];
  return [{ lat: m.coordinates.y, lng: m.coordinates.x, display_name: m.matchedAddress }];
}

async function geocodeAddress(str) {
  const nominatimP = fetch(`/api/geocode/nominatim?address=${encodeURIComponent(str)}`)
    .then(r => r.ok ? r.json() : [])
    .then(data => (data || []).map(r => ({
      lat: parseFloat(r.lat), lng: parseFloat(r.lon), display_name: r.display_name,
    })))
    .catch(() => []);

  const censusP = fetch(`/api/geocode/census?address=${encodeURIComponent(str)}`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      const matches = data?.result?.addressMatches;
      if (!matches || matches.length === 0) return [];
      return matches.map(m => ({
        lat: m.coordinates.y, lng: m.coordinates.x, display_name: m.matchedAddress,
      }));
    })
    .catch(() => []);

  const [census, nominatim] = await Promise.all([censusP, nominatimP]);

  // Census is authoritative for US addresses — use exclusively when available
  // Nominatim is fallback for international addresses or Census misses
  if (census.length > 0) return census;
  if (nominatim.length > 0) return nominatim;
  throw new Error('No results found for this address');
}


async function resolveLocation(input) {
  const trimmed = input.trim();
  if (!trimmed) throw new Error('Please enter an address, coordinates, or Google Maps URL');

  // 1. Google Maps URL
  if (trimmed.includes('google.com/maps') || trimmed.includes('goo.gl/maps')) {
    const coords = parseGoogleMapsUrl(trimmed);
    if (coords) return { ...coords, display_name: 'Extracted from Google Maps URL', source: 'google_maps' };
    throw new Error('Could not extract coordinates from Google Maps URL');
  }

  // 2. Raw coordinates
  const rawCoords = parseRawCoords(trimmed);
  if (rawCoords) return { ...rawCoords, display_name: `Raw coordinates`, source: 'raw_coords' };

  // 3. Address geocoding via Nominatim
  const results = await geocodeAddress(trimmed);
  return { ...results[0], source: 'nominatim', alternatives: results.slice(1) };
}

function showResolveResult(result) {
  S.resolved = result;
  const container = document.getElementById('sf-resolve-result');
  const alternatives = result.alternatives || [];

  let html = `<div class="bg-gray-800/50 border border-gray-700 rounded px-3 py-2 text-sm space-y-1">
    <div class="flex items-center gap-2">
      <span class="text-green-400">&#10003;</span>
      <span class="text-gray-200 font-medium">${result.lat.toFixed(6)}, ${result.lng.toFixed(6)}</span>
      <button type="button" onclick="showManualOverride()" class="text-xs text-blue-400 hover:text-blue-300 ml-auto">Edit</button>
    </div>
    <div class="text-xs text-gray-400 truncate" title="${esc(result.display_name)}">${esc(result.display_name)}</div>`;

  if (alternatives.length > 0) {
    html += `<details class="mt-1"><summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Other results (${alternatives.length})</summary><div class="mt-1 space-y-1">`;
    alternatives.forEach((alt, i) => {
      html += `<div class="flex items-center gap-2 text-xs text-gray-400 hover:text-gray-200 cursor-pointer" onclick="pickAlternative(${i})">
        <span class="text-gray-600">&bull;</span>
        <span>${alt.lat.toFixed(6)}, ${alt.lng.toFixed(6)}</span>
        <span class="truncate text-gray-500">${esc(alt.display_name)}</span>
      </div>`;
    });
    html += '</div></details>';
  }

  html += '</div>';
  container.innerHTML = html;
  container.classList.remove('hidden');
  document.getElementById('sf-manual-override').classList.add('hidden');
  document.getElementById('sf-submit').disabled = false;
}

function pickAlternative(idx) {
  const alt = S.resolved.alternatives[idx];
  if (!alt) return;
  const oldAlts = [{ lat: S.resolved.lat, lng: S.resolved.lng, display_name: S.resolved.display_name },
    ...S.resolved.alternatives.filter((_, i) => i !== idx)];
  showResolveResult({ ...alt, source: 'nominatim', alternatives: oldAlts });
}

function showResolveError(msg) {
  S.resolved = null;
  const container = document.getElementById('sf-resolve-result');
  container.innerHTML = `<div class="bg-red-900/30 border border-red-800 rounded px-3 py-2 text-sm flex items-center gap-2">
    <span class="text-red-400">&#10007;</span>
    <span class="text-red-300">${esc(msg)}</span>
    <button type="button" onclick="showManualOverride()" class="text-xs text-blue-400 hover:text-blue-300 ml-auto">Enter manually</button>
  </div>`;
  container.classList.remove('hidden');
  document.getElementById('sf-submit').disabled = true;
}

function showManualOverride() {
  const override = document.getElementById('sf-manual-override');
  override.classList.remove('hidden');
  if (S.resolved) {
    document.getElementById('sf-lat').value = S.resolved.lat;
    document.getElementById('sf-lng').value = S.resolved.lng;
  }
}

function applyManualCoords() {
  const lat = parseFloat(document.getElementById('sf-lat').value);
  const lng = parseFloat(document.getElementById('sf-lng').value);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    toast('Invalid coordinates. Lat: -90 to 90, Lng: -180 to 180', 'error');
    return;
  }
  showResolveResult({ lat, lng, display_name: 'Manual entry', source: 'manual' });
}

function cancelManualOverride() {
  document.getElementById('sf-manual-override').classList.add('hidden');
}

async function handleResolve() {
  const input = document.getElementById('sf-location').value;
  const btn = document.getElementById('sf-resolve');
  btn.disabled = true;
  btn.textContent = 'Resolving...';
  try {
    const result = await resolveLocation(input);
    showResolveResult(result);
  } catch (err) {
    showResolveError(err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Resolve';
  }
}

function resetResolveState() {
  S.resolved = null;
  document.getElementById('sf-resolve-result').classList.add('hidden');
  document.getElementById('sf-resolve-result').innerHTML = '';
  document.getElementById('sf-manual-override').classList.add('hidden');
  document.getElementById('sf-submit').disabled = true;
}

// --- Scan form ---
async function submitScan(e) {
  e.preventDefault();
  if (!S.resolved) {
    toast('Please resolve a location first', 'error');
    return;
  }

  const btn = document.getElementById('sf-submit');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  const body = {
    name: document.getElementById('sf-name').value.trim(),
    lat: S.resolved.lat,
    lng: S.resolved.lng,
  };
  const addr = document.getElementById('sf-location').value.trim();
  if (addr && S.resolved.source !== 'raw_coords') body.address = addr;

  try {
    await api('POST', '/api/scan', body);
    toast(`Scan queued for ${body.name}`);
    document.getElementById('scan-form').reset();
    resetResolveState();
    S.offset = 0;
    fetchScans();
    fetchHealth();
  } catch (err) {
    toast('Submit failed: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Scan';
  }
}

// --- Event listeners ---
document.addEventListener('DOMContentLoaded', () => {
  // Scan form
  document.getElementById('scan-form').addEventListener('submit', submitScan);
  document.getElementById('sf-resolve').addEventListener('click', handleResolve);
  document.getElementById('sf-location').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); handleResolve(); }
  });
  // Reset resolved state when location input changes
  document.getElementById('sf-location').addEventListener('input', () => {
    if (S.resolved) resetResolveState();
  });

  // Settings save
  document.getElementById('settings-form').addEventListener('submit', saveSettings);

  // Filters
  let searchTimer;
  document.getElementById('search-input').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { S.offset = 0; fetchScans(); }, 300);
  });
  document.getElementById('filter-status').addEventListener('change', () => { S.offset = 0; fetchScans(); });
  document.getElementById('filter-method').addEventListener('change', () => { S.offset = 0; fetchScans(); });

  // Select all checkbox
  document.getElementById('select-all').addEventListener('change', (e) => {
    const checked = e.target.checked;
    S.scans.forEach(s => {
      if (checked) S.selected.add(s.id);
      else S.selected.delete(s.id);
    });
    updateDeleteBtn();
    renderTable();
  });

  // Delete button
  document.getElementById('delete-btn').addEventListener('click', deleteSelected);

  // Refresh
  document.getElementById('refresh-btn').addEventListener('click', fetchScans);

  // Pagination
  document.getElementById('prev-btn').addEventListener('click', () => {
    S.offset = Math.max(0, S.offset - S.limit);
    fetchScans();
  });
  document.getElementById('next-btn').addEventListener('click', () => {
    S.offset += S.limit;
    fetchScans();
  });

  // Column sorting
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.sort;
      if (S.sortField === field) {
        S.sortDir = S.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        S.sortField = field;
        S.sortDir = 'asc';
      }
      document.querySelectorAll('th[data-sort]').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      th.classList.add(S.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
      renderTable();
    });
  });

  // Router
  window.addEventListener('hashchange', handleHash);
  handleHash();

  // Health polling
  fetchHealth();
  setInterval(fetchHealth, 30000);
});
</script>
</body>
</html>
