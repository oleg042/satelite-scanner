<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Satellite Scanner</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  @keyframes pulse-bg { 0%,100%{opacity:1} 50%{opacity:.6} }
  .pulse-badge { animation: pulse-bg 1.5s ease-in-out infinite; }
  th[data-sort]::after { content: ' \2191\2193'; font-size: .85em; opacity: .4; }
  th[data-sort]:hover::after { opacity: .7; }
  .sort-asc::after { content: ' \2191' !important; opacity: 1 !important; }
  .sort-desc::after { content: ' \2193' !important; opacity: 1 !important; }
  .toast{animation:slideIn .3s ease}
  @keyframes slideIn{from{transform:translateY(-1rem);opacity:0}to{transform:translateY(0);opacity:1}}
  .nav-item{display:flex;align-items:center;gap:.5rem;padding:.5rem .75rem;border-radius:.375rem;font-size:.875rem;transition:all .15s;cursor:pointer;color:#9ca3af}
  .nav-item:hover{background:#1f2937;color:#e5e7eb}
  .nav-item.active{background:#1d4ed8;color:#fff}
  .boundary-overlay{position:absolute;border:2px solid #ef4444;pointer-events:none;z-index:5;border-radius:2px}
  #image-modal .boundary-overlay{border-width:3px}
  .msft-overlay{position:absolute;left:0;top:0;pointer-events:none;z-index:4}
  #image-modal .msft-overlay polygon{stroke-width:2}
  #image-modal{transition:opacity .2s}
  #image-modal.hidden{opacity:0;pointer-events:none}
</style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen flex">

<!-- Toast container -->
<div id="toasts" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Sidebar -->
<aside class="w-56 bg-gray-900 border-r border-gray-800 flex flex-col min-h-screen shrink-0">
  <!-- Logo -->
  <div class="px-4 py-5 border-b border-gray-800">
    <h1 class="text-lg font-bold tracking-tight">Satellite Scanner</h1>
  </div>

  <!-- Navigation -->
  <nav class="flex-1 px-3 py-4 space-y-1">
    <a class="nav-item" data-page="scans" href="#scans">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
      Scans
    </a>
    <a class="nav-item" data-page="settings" href="#settings">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      Settings
    </a>
  </nav>

  <!-- Health status at bottom -->
  <div class="px-4 py-3 border-t border-gray-800">
    <div id="health-badge" class="flex items-center gap-2 text-xs text-gray-400">
      <span class="w-2 h-2 rounded-full bg-green-500 shrink-0"></span>
      <span>Healthy</span>
      <span class="text-gray-600">Queue: <span id="queue-size">0</span></span>
    </div>
  </div>
</aside>

<!-- Main content -->
<div class="flex-1 flex flex-col min-h-screen overflow-hidden">

  <!-- ==================== SCANS PAGE ==================== -->
  <div id="page-scans" class="page flex-1 flex flex-col overflow-hidden">

    <!-- Top bar: scan form + page header -->
    <div class="border-b border-gray-800 bg-gray-900/50 px-6 py-4">
      <div class="flex items-start gap-6">
        <!-- New Scan form (inline) -->
        <form id="scan-form" class="flex flex-wrap items-end gap-3">
          <div class="w-56">
            <label class="block text-xs text-gray-500 mb-1">Facility Name</label>
            <input id="sf-name" type="text" placeholder="Amerequip Corporation" required
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
          </div>
          <div class="w-56">
            <label class="block text-xs text-gray-500 mb-1">Address / Location</label>
            <input id="sf-location" type="text" placeholder="123 Main St, City, ST  or  Google Maps URL  or  41.05, -80.67" required
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
          </div>
          <button id="sf-resolve" type="button"
            class="bg-gray-700 hover:bg-gray-600 active:scale-95 text-white font-medium rounded px-4 py-1.5 text-sm transition whitespace-nowrap">
            Resolve
          </button>
          <button id="sf-submit" type="submit" disabled
            class="bg-blue-600 hover:bg-blue-700 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium rounded px-4 py-1.5 text-sm transition whitespace-nowrap">
            Submit Scan
          </button>
          <!-- Resolve result area -->
          <div id="sf-resolve-result" class="hidden basis-full">
            <!-- Filled dynamically by JS -->
          </div>
          <!-- Manual override inputs (hidden by default) -->
          <div id="sf-manual-override" class="hidden basis-full flex items-end gap-3">
            <div>
              <label class="block text-xs text-gray-500 mb-1">Latitude</label>
              <input id="sf-lat" type="number" step="any" placeholder="41.0534"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-32 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <div>
              <label class="block text-xs text-gray-500 mb-1">Longitude</label>
              <input id="sf-lng" type="number" step="any" placeholder="-80.6753"
                class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-32 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <button type="button" onclick="applyManualCoords()" class="bg-gray-700 hover:bg-gray-600 active:scale-95 text-white font-medium rounded px-3 py-1.5 text-sm transition">Apply</button>
            <button type="button" onclick="cancelManualOverride()" class="text-gray-500 hover:text-gray-300 active:scale-95 text-sm transition">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="px-6 py-3 flex flex-wrap items-center gap-3 border-b border-gray-800/50">
      <input id="search-input" type="text" placeholder="Search name or address..."
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm w-56 focus:ring-1 focus:ring-blue-500 outline-none">
      <select id="filter-status"
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="queued">Queued</option>
        <option value="failed">Failed</option>
        <option value="skipped">Skipped</option>
        <option value="completed">Completed</option>
      </select>
      <select id="filter-bins"
        class="bg-gray-800 border border-gray-700 rounded px-3 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
        <option value="">All Bins</option>
        <option value="true">Bins Found</option>
        <option value="false">No Bins</option>
      </select>
      <label class="inline-flex items-center gap-2 cursor-pointer select-none" title="Toggle company grouping">
        <span id="group-label-flat" class="text-sm text-blue-400 font-medium">Flat</span>
        <div class="relative">
          <input type="checkbox" id="group-toggle" class="sr-only peer">
          <div class="w-9 h-5 bg-gray-700 rounded-full peer peer-checked:bg-blue-600 transition"></div>
          <div class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full shadow peer-checked:translate-x-4 transition"></div>
        </div>
        <span id="group-label-grouped" class="text-sm text-gray-500">Grouped</span>
      </label>
      <button id="import-btn" title="Bulk import facilities"
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-95 rounded px-3 py-1.5 text-sm transition">
        Import
      </button>
      <button id="refresh-btn" title="Refresh"
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-95 rounded px-3 py-1.5 text-sm transition">
        &#8635; Refresh
      </button>
      <button id="scan-pending-btn"
        class="bg-green-700 hover:bg-green-600 active:scale-95 text-white font-medium rounded px-3 py-1.5 text-sm transition">
        Scan All Pending
      </button>
      <div id="scan-stats" class="ml-auto text-right text-sm leading-snug">
        <div><span class="text-gray-500">Facilities</span> <span id="stat-total" class="text-gray-300 font-medium">0</span> <span class="text-gray-600 mx-1">&middot;</span> <span class="text-gray-500">Completed</span> <span id="stat-completed" class="text-gray-300 font-medium">0</span></div>
        <div><span class="text-gray-500">Bins Found</span> <span id="stat-bins" class="text-green-400 font-medium">0</span></div>
      </div>
      <button id="scan-selected-btn" disabled
        class="bg-green-700 hover:bg-green-600 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium rounded px-3 py-1.5 text-sm transition hidden">
        Scan Selected (<span id="scan-selected-count">0</span>)
      </button>
      <button id="detect-bins-btn" disabled
        class="bg-purple-700 hover:bg-purple-600 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium rounded px-3 py-1.5 text-sm transition hidden">
        Detect Bins (<span id="detect-bins-count">0</span>)
      </button>
      <button id="delete-btn" disabled
        class="bg-red-700 hover:bg-red-600 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium rounded px-3 py-1.5 text-sm transition hidden">
        Delete Selected (<span id="delete-count">0</span>)
      </button>
    </div>

    <!-- Table (scrollable) -->
    <div class="flex-1 overflow-auto px-6 py-4">
      <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="sticky top-0 bg-gray-900 z-10">
            <tr class="border-b border-gray-800 text-gray-400 text-left">
              <th class="px-3 py-2.5 w-8"><input id="select-all" type="checkbox" class="rounded bg-gray-800 border-gray-600 cursor-pointer"></th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="index">#</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="facility_name">Facility</th>
              <th class="px-3 py-2.5 font-medium whitespace-nowrap">Search</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="status">Status</th>
              <th class="px-3 py-2.5 font-medium whitespace-nowrap">Coords</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="bbox">BBox</th>
              <th class="px-3 py-2.5 font-medium whitespace-nowrap">Bins</th>
              <th class="px-3 py-2.5 font-medium whitespace-nowrap">Qty</th>
              <th class="px-3 py-2.5 font-medium whitespace-nowrap">Conf</th>
              <th class="px-3 py-2.5 font-medium cursor-pointer select-none hover:text-gray-200 whitespace-nowrap" data-sort="started_at">Date</th>
            </tr>
          </thead>
          <tbody id="scan-tbody"></tbody>
        </table>
        <!-- Empty state -->
        <div id="empty-state" class="hidden text-center py-12 text-gray-500">
          No scans found. Submit a facility above to get started.
        </div>
        <!-- Loading state -->
        <div id="loading-state" class="text-center py-12 text-gray-500">
          Loading scans...
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-3 border-t border-gray-800 flex items-center justify-between shrink-0">
      <button id="prev-btn" disabled
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed rounded px-4 py-1.5 text-sm transition">
        &larr; Prev
      </button>
      <span id="page-info" class="text-sm text-gray-500"></span>
      <button id="next-btn" disabled
        class="bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed rounded px-4 py-1.5 text-sm transition">
        Next &rarr;
      </button>
    </div>
  </div>

  <!-- ==================== IMPORT MODAL ==================== -->
  <div id="import-modal" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/60">
    <div class="bg-gray-900 border border-gray-700 rounded-lg shadow-xl w-full max-w-lg mx-4">
      <div class="px-5 py-4 border-b border-gray-800 flex items-center justify-between">
        <h3 class="font-semibold">Bulk Import Facilities</h3>
        <button onclick="closeImportModal()" class="text-gray-500 hover:text-gray-300 active:scale-95 text-lg">&times;</button>
      </div>
      <div class="px-5 py-4 space-y-3">
        <!-- Tab switcher -->
        <div class="flex gap-1 bg-gray-800 rounded-lg p-0.5">
          <button id="import-tab-paste" onclick="switchImportTab('paste')" class="flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition bg-gray-700 text-white">Paste</button>
          <button id="import-tab-csv" onclick="switchImportTab('csv')" class="flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition text-gray-400 hover:text-gray-200">CSV</button>
        </div>
        <!-- Paste tab -->
        <div id="import-panel-paste">
          <p class="text-sm text-gray-400 mb-2">Paste tab-separated rows: <code class="text-xs bg-gray-800 px-1 rounded">Name&#9;Address&#9;Domain</code></p>
          <textarea id="import-textarea" rows="10" placeholder="Acme Steel Corp&#9;123 Industrial Blvd, Detroit, MI&#9;acmesteel.com&#10;Metro Fabricators&#9;456 Factory Rd, Cleveland, OH&#10;Precision Metals"
            class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm font-mono focus:ring-1 focus:ring-blue-500 outline-none resize-y"></textarea>
        </div>
        <!-- CSV tab -->
        <div id="import-panel-csv" class="hidden">
          <p class="text-sm text-gray-400 mb-2">Upload a CSV file with columns: <code class="text-xs bg-gray-800 px-1 rounded">Name, Address, Domain</code></p>
          <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-gray-500 transition bg-gray-800/50">
            <div id="csv-upload-label" class="flex flex-col items-center justify-center py-4">
              <svg class="w-8 h-8 mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
              <p class="text-sm text-gray-400">Click to upload CSV</p>
            </div>
            <input id="import-csv-input" type="file" accept=".csv" class="hidden">
          </label>
        </div>
        <div class="flex items-center justify-between">
          <span id="import-count" class="text-sm text-gray-500">0 entries</span>
          <div class="flex gap-2">
            <button onclick="closeImportModal()" class="bg-gray-700 hover:bg-gray-600 active:scale-95 text-white font-medium rounded px-4 py-1.5 text-sm transition">Cancel</button>
            <button id="import-submit-btn" onclick="submitImport()" disabled
              class="bg-blue-600 hover:bg-blue-700 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium rounded px-4 py-1.5 text-sm transition">Import</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ==================== IMAGE MODAL ==================== -->
  <div id="image-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/80" onclick="if(event.target===this)closeImageModal()">
    <div class="relative max-w-[90vw] max-h-[90vh] flex flex-col items-center">
      <button onclick="closeImageModal()" class="absolute -top-3 -right-3 z-10 bg-gray-800 hover:bg-gray-700 active:scale-95 text-gray-300 hover:text-white rounded-full w-8 h-8 flex items-center justify-center text-lg shadow-lg border border-gray-600">&times;</button>
      <div id="image-modal-container" class="relative inline-block bbox-overlay-container">
        <img id="image-modal-img" src="" alt="Screenshot" class="max-w-[88vw] max-h-[82vh] rounded-lg border border-gray-700 object-contain">
      </div>
      <div id="image-modal-caption" class="mt-2 text-sm text-gray-400 text-center"></div>
    </div>
  </div>

  <!-- ==================== SETTINGS PAGE ==================== -->
  <div id="page-settings" class="page hidden flex-1 overflow-auto">
    <div class="px-6 py-6 max-w-3xl">
      <h2 class="text-xl font-bold mb-1">Settings</h2>
      <p class="text-sm text-gray-500 mb-6">Configure API keys, AI models, and scan defaults.</p>

      <form id="settings-form" class="space-y-6">
        <!-- API Key -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">API Configuration</h3>
          <div>
            <label class="block text-sm text-gray-300 mb-1.5">OpenAI API Key</label>
            <input id="set-api-key" type="password" placeholder="sk-..."
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none max-w-md">
            <p class="text-xs text-gray-600 mt-1">Leave blank to keep current key. Current: <span id="set-api-key-mask" class="text-gray-500">not set</span></p>
          </div>
          <div>
            <label class="block text-sm text-gray-300 mb-1.5">Serper API Key</label>
            <input id="set-serper-key" type="password" placeholder="serper-..."
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none max-w-md">
            <p class="text-xs text-gray-600 mt-1">Leave blank to keep current key. Current: <span id="set-serper-key-mask" class="text-gray-500">not set</span></p>
          </div>
        </div>

        <!-- Scan Defaults -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">Scan Defaults</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Default Zoom</label>
              <input id="set-default-zoom" type="number" min="16" max="22"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Tile zoom for detail (16–22)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Buffer (meters)</label>
              <input id="set-buffer" type="number" min="10" max="500"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Padding around OSM bbox (10–500)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Overview Zoom</label>
              <input id="set-overview-zoom" type="number" min="16" max="21"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Zoom for AI validation images (16–21)</p>
            </div>
          </div>
        </div>

        <!-- Performance (per-scan, dynamic) -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">Performance</h3>
          <p class="text-xs text-gray-500 -mt-2">Per-scan settings — changes take effect on the next scan.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Tile Delay (seconds)</label>
              <input id="set-tile-delay" type="number" min="0" max="5" step="0.01"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Delay between tile downloads (rate limiting)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Tile Concurrency</label>
              <input id="set-tile-concurrency" type="number" min="1" max="50"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Max parallel tile downloads per scan</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Max Image MB</label>
              <input id="set-max-image-mb" type="number" min="16" max="1024"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">PIL memory threshold before chunked stitching</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">DuckDB Memory Limit</label>
              <input id="set-duckdb-memory" type="text" placeholder="128MB"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Memory limit for Overture queries (e.g. 128MB, 256MB)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">DuckDB Threads</label>
              <input id="set-duckdb-threads" type="number" min="1" max="16"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Thread count for Overture queries</p>
            </div>
          </div>
        </div>

        <!-- AI Models -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">AI Models</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Validation Model</label>
              <select id="set-validation-model"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="">Select model...</option>
                <optgroup label="Flagship">
                  <option value="gpt-5.2">GPT-5.2 (Latest flagship)</option>
                  <option value="gpt-5.1">GPT-5.1</option>
                  <option value="gpt-5">GPT-5</option>
                  <option value="gpt-4.1">GPT-4.1 (1M context)</option>
                </optgroup>
                <optgroup label="Reasoning">
                  <option value="o3">o3 (Visual reasoning)</option>
                  <option value="o3-pro">o3 Pro (Most reliable)</option>
                </optgroup>
                <optgroup label="Efficient">
                  <option value="gpt-5-mini">GPT-5 Mini</option>
                  <option value="gpt-4.1-mini">GPT-4.1 Mini (1M context)</option>
                  <option value="gpt-4.1-nano">GPT-4.1 Nano (cheapest)</option>
                </optgroup>
              </select>
              <p class="text-xs text-gray-600 mt-1">Used for OSM bbox validation (step 2)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Boundary Model</label>
              <select id="set-boundary-model"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="">Select model...</option>
                <optgroup label="Flagship">
                  <option value="gpt-5.2">GPT-5.2 (Latest flagship)</option>
                  <option value="gpt-5.1">GPT-5.1</option>
                  <option value="gpt-5">GPT-5</option>
                  <option value="gpt-4.1">GPT-4.1 (1M context)</option>
                </optgroup>
                <optgroup label="Reasoning">
                  <option value="o3">o3 (Visual reasoning)</option>
                  <option value="o3-pro">o3 Pro (Most reliable)</option>
                </optgroup>
                <optgroup label="Efficient">
                  <option value="gpt-5-mini">GPT-5 Mini</option>
                  <option value="gpt-4.1-mini">GPT-4.1 Mini (1M context)</option>
                  <option value="gpt-4.1-nano">GPT-4.1 Nano (cheapest)</option>
                </optgroup>
              </select>
              <p class="text-xs text-gray-600 mt-1">Used for boundary detection + correction (step 3)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Verification Model</label>
              <select id="set-verification-model"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="">Select model...</option>
                <optgroup label="Flagship">
                  <option value="gpt-5.2">GPT-5.2 (Latest flagship)</option>
                  <option value="gpt-5.1">GPT-5.1</option>
                  <option value="gpt-5">GPT-5</option>
                  <option value="gpt-4.1">GPT-4.1 (1M context)</option>
                </optgroup>
                <optgroup label="Reasoning">
                  <option value="o3">o3 (Visual reasoning)</option>
                  <option value="o3-pro">o3 Pro (Most reliable)</option>
                </optgroup>
                <optgroup label="Efficient">
                  <option value="gpt-5-mini">GPT-5 Mini</option>
                  <option value="gpt-4.1-mini">GPT-4.1 Mini (1M context)</option>
                  <option value="gpt-4.1-nano">GPT-4.1 Nano (cheapest)</option>
                </optgroup>
              </select>
              <p class="text-xs text-gray-600 mt-1">Used for boundary verification (step 3d)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Correction Mode</label>
              <select id="set-correction-mode"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="v1">V1 — Multi-agent (verify → correct → verify)</option>
                <option value="v2">V2 — Single-agent (verify + correct in one call)</option>
              </select>
              <p class="text-xs text-gray-600 mt-1">V2 saves 1 API call per retry and eliminates handoff loss</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">BBox AI Validation</label>
              <label class="flex items-center gap-2 cursor-pointer mt-2">
                <div class="relative">
                  <input id="set-bbox-validation" type="checkbox" class="sr-only peer">
                  <div class="w-9 h-5 bg-gray-700 rounded-full peer-checked:bg-blue-600 transition-colors"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                </div>
                <span class="text-sm text-gray-400">Enable</span>
              </label>
              <p class="text-xs text-gray-600 mt-1">AI validates bbox accuracy after boundary detection</p>
            </div>
          </div>
        </div>

        <!-- AI Prompts -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">AI Prompts</h3>
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="text-sm text-gray-300">Validation Prompt</label>
              <button type="button" onclick="resetPrompt('validation')"
                class="text-xs text-gray-500 hover:text-gray-300 active:scale-95 transition">Reset to default</button>
            </div>
            <textarea id="set-validation-prompt" rows="6"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with the overview image during OSM bbox validation (step 2). Supports {name}, {lat}, {lng}, {width_m}, {height_m} placeholders.</p>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="text-sm text-gray-300">Boundary Detection Prompt</label>
              <button type="button" onclick="resetPrompt('boundary')"
                class="text-xs text-gray-500 hover:text-gray-300 active:scale-95 transition">Reset to default</button>
            </div>
            <textarea id="set-boundary-prompt" rows="10"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with the satellite image for facility boundary identification (step 3). Image context is appended automatically.</p>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="text-sm text-gray-300">Verification Prompt</label>
              <button type="button" onclick="resetPrompt('verification')"
                class="text-xs text-gray-500 hover:text-gray-300 active:scale-95 transition">Reset to default</button>
            </div>
            <textarea id="set-verification-prompt" rows="6"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with the annotated image (red rectangle) to verify AI-detected boundaries (step 3). Supports {name} placeholder.</p>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="text-sm text-gray-300">Verification-Correction Prompt <span class="text-gray-600">(V2 only)</span></label>
              <button type="button" onclick="resetPrompt('verification_correction')"
                class="text-xs text-gray-500 hover:text-gray-300 active:scale-95 transition">Reset to default</button>
            </div>
            <textarea id="set-verification-correction-prompt" rows="6"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">V2 task instructions: tells the model to both verify AND provide corrected coordinates when rejecting. Inserted between boundary_prompt and image context.</p>
          </div>
        </div>

        <!-- Bin Detection -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-5 space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">Bin Detection</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Enable Bin Detection</label>
              <label class="flex items-center gap-2 cursor-pointer mt-2">
                <div class="relative">
                  <input id="set-bin-detection-enabled" type="checkbox" class="sr-only peer">
                  <div class="w-9 h-5 bg-gray-700 rounded-full peer-checked:bg-purple-600 transition-colors"></div>
                  <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                </div>
                <span class="text-sm text-gray-400">Enable</span>
              </label>
              <p class="text-xs text-gray-600 mt-1">Auto-detect scrap bins in pipeline</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Bin Detection Model</label>
              <select id="set-bin-detection-model"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                <option value="">Select model...</option>
                <optgroup label="Flagship">
                  <option value="gpt-5.2">GPT-5.2 (Latest flagship)</option>
                  <option value="gpt-5.1">GPT-5.1</option>
                  <option value="gpt-5">GPT-5</option>
                  <option value="gpt-4.1">GPT-4.1 (1M context)</option>
                </optgroup>
                <optgroup label="Reasoning">
                  <option value="o3">o3 (Visual reasoning)</option>
                  <option value="o3-pro">o3 Pro (Most reliable)</option>
                </optgroup>
                <optgroup label="Efficient">
                  <option value="gpt-5-mini">GPT-5 Mini</option>
                  <option value="gpt-4.1-mini">GPT-4.1 Mini (1M context)</option>
                  <option value="gpt-4.1-nano">GPT-4.1 Nano (cheapest)</option>
                </optgroup>
              </select>
              <p class="text-xs text-gray-600 mt-1">AI model for bin detection chunks</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Max Chunk Size (meters)</label>
              <input id="set-bin-max-chunk" type="number" min="50" max="200"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Max chunk dimension for AI analysis (50-200)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Min Bin Confidence (%)</label>
              <input id="set-bin-min-confidence" type="number" min="0" max="100"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Bins below this confidence are excluded from counts (0-100)</p>
            </div>
            <div>
              <label class="flex items-center gap-2 cursor-pointer mt-2">
                <input id="set-bin-delete-final" type="checkbox"
                  class="rounded bg-gray-800 border-gray-600 cursor-pointer"
                  onchange="if(this.checked) document.getElementById('set-bin-resize-final').checked = false">
                <span class="text-sm text-gray-300">Delete Final Image After Detection</span>
              </label>
              <p class="text-xs text-gray-600 mt-1">Remove the large final image from storage once bin detection completes. Chunk screenshots are kept.</p>
            </div>
            <div>
              <label class="flex items-center gap-2 cursor-pointer mt-2">
                <input id="set-bin-resize-final" type="checkbox"
                  class="rounded bg-gray-800 border-gray-600 cursor-pointer"
                  onchange="if(this.checked) document.getElementById('set-bin-delete-final').checked = false">
                <span class="text-sm text-gray-300">Resize Final Image After Detection (50%)</span>
              </label>
              <p class="text-xs text-gray-600 mt-1">Shrink the final image to half its dimensions after bin detection. Keeps the image but cuts file size ~75%.</p>
            </div>
            <div>
              <label class="flex items-center gap-2 cursor-pointer mt-2">
                <input id="set-bin-reasoning" type="checkbox"
                  class="rounded bg-gray-800 border-gray-600 cursor-pointer" checked>
                <span class="text-sm text-gray-300">Include Per-Bin Reasoning in Prompt</span>
              </label>
              <p class="text-xs text-gray-600 mt-1">When disabled, the "reasoning" field is stripped from the prompt to save tokens and reduce hallucination.</p>
            </div>
          </div>
          <div>
            <div class="flex items-center justify-between mb-1.5">
              <label class="text-sm text-gray-300">Bin Detection Prompt</label>
              <button type="button" onclick="resetPrompt('bin_detection')"
                class="text-xs text-gray-500 hover:text-gray-300 active:scale-95 transition">Reset to default</button>
            </div>
            <textarea id="set-bin-detection-prompt" rows="10"
              class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none font-mono leading-relaxed"></textarea>
            <p class="text-xs text-gray-600 mt-1">Sent with each image chunk. Supports {image_width_m}, {image_height_m}, {image_width_px}, {image_height_px}, {meters_per_pixel}, {bin_width_px}, {bin_length_min_px}, {bin_length_max_px} placeholders.</p>
          </div>
        </div>

        <!-- Infrastructure (require restart) -->
        <div class="bg-gray-900 border border-amber-700/50 rounded-lg p-5 space-y-4">
          <div class="flex items-center gap-3">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-gray-400">Infrastructure</h3>
            <span class="text-xs bg-amber-600/20 text-amber-400 border border-amber-600/30 rounded px-2 py-0.5 font-medium">Restart Required</span>
            <button id="restart-btn" onclick="restartService()" class="ml-auto bg-amber-600 hover:bg-amber-500 active:scale-95 text-white font-medium rounded px-3 py-1 text-xs transition">Restart Service</button>
          </div>
          <p class="text-xs text-gray-500 -mt-2">These control worker pools and semaphores created at startup. Changes take effect after restarting the app.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Worker Concurrency</label>
              <input id="set-worker-concurrency" type="number" min="1" max="20"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Concurrent scan workers pulling from queue</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Heavy Phase Concurrency</label>
              <input id="set-heavy-concurrency" type="number" min="1" max="10"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Max scans in tile + vision phase (semaphore)</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Browser Concurrency</label>
              <input id="set-browser-concurrency" type="number" min="1" max="10"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Max Playwright browser contexts</p>
            </div>
            <div>
              <label class="block text-sm text-gray-300 mb-1.5">Stale Scan Timeout (minutes)</label>
              <input id="set-stale-timeout" type="number" min="5" max="120"
                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
              <p class="text-xs text-gray-600 mt-1">Watchdog timeout before re-queuing hung scans</p>
            </div>
          </div>
        </div>

        <!-- Save -->
        <div class="flex items-center gap-3">
          <button type="submit"
            class="bg-blue-600 hover:bg-blue-700 active:scale-95 text-white font-medium rounded px-5 py-2 text-sm transition">
            Save Settings
          </button>
          <span id="settings-status" class="text-sm text-gray-500"></span>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
// --- State ---
const S = {
  scans: [],
  sortField: null,
  sortDir: 'asc',
  offset: 0,
  limit: 50,
  expanded: {},
  expandedOpen: {},
  selected: new Set(),
  lastCheckedIdx: null,
  pollTimer: null,
  currentPage: 'scans',
  // Geocoding resolved state
  resolved: null, // { lat, lng, display_name, source }
  settings: {},
  groupByCompany: false,
  collapsedGroups: new Set(),
  _detectingIds: new Set(),
};

// --- Router ---
function navigate(page) {
  S.currentPage = page;
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  const target = document.getElementById(`page-${page}`);
  if (target) target.classList.remove('hidden');

  document.querySelectorAll('.nav-item').forEach(n => {
    n.classList.toggle('active', n.dataset.page === page);
  });

  if (page === 'settings') loadSettings();
  if (page === 'scans') fetchScans();
}

function handleHash() {
  const hash = location.hash.replace('#', '') || 'scans';
  navigate(hash);
}

// --- API helper ---
async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(path, opts);
  if (!res.ok) {
    const err = await res.json().catch(() => ({ detail: res.statusText }));
    throw new Error(err.detail || JSON.stringify(err));
  }
  return res.status === 204 ? null : res.json();
}

// --- Toast ---
function toast(msg, type = 'success') {
  const el = document.createElement('div');
  const colors = type === 'success' ? 'bg-green-600' : type === 'info' ? 'bg-blue-600' : 'bg-red-600';
  el.className = `toast ${colors} text-white text-sm px-4 py-2 rounded shadow-lg max-w-md`;
  el.textContent = msg;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), type === 'success' ? 4000 : 8000);
}

// --- Restart service ---
async function restartService() {
  const btn = document.getElementById('restart-btn');
  if (!confirm('Restart the Railway service? The app will be briefly unavailable.')) return;
  btn.disabled = true;
  btn.textContent = 'Restarting…';
  try {
    await api('POST', '/api/restart');
    toast('Restart triggered — service will be back in ~30s', 'info');
  } catch (e) {
    toast('Restart failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Restart Service';
  }
}

// --- Status badge ---
function statusBadge(scan, scanId) {
  const status = typeof scan === 'string' ? scan : scan.status;
  const binStatus = typeof scan === 'object' ? scan.bin_detection_status : null;

  // Temporary detecting state — pulsing purple badge (uses durable Set, survives fetchScans)
  if (typeof scan === 'object' && S._detectingIds.has(scan.id)) {
    return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium bg-purple-600 text-purple-100 pulse-badge">detecting bins</span>`;
  }

  const map = {
    pending: 'bg-purple-700 text-purple-100',
    queued: 'bg-gray-600 text-gray-100',
    running_osm: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_validate: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_vision: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_msft: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_overture: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_tiling: 'bg-yellow-600 text-yellow-100 pulse-badge',
    running_bin_detection: 'bg-purple-600 text-purple-100 pulse-badge',
    completed: 'bg-green-700 text-green-100',
    failed: 'bg-red-700 text-red-100',
    skipped: 'bg-blue-700 text-blue-100',
  };
  const cls = map[status] || 'bg-gray-600 text-gray-100';
  let label = (status || '').replace(/_/g, ' ');

  // Facility pipeline done but bin detection not yet run → "building found"
  if (status === 'completed' && !binStatus) {
    label = 'building found';
  }

  if ((status === 'failed' || status === 'skipped') && scanId) {
    return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium cursor-pointer hover:brightness-125 ${cls}" onclick="event.stopPropagation(); showScanReason('${scanId}')" title="Click to see details">${label}</span>`;
  }
  return `<span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${cls}">${label}</span>`;
}

function showScanReason(scanId) {
  const scan = S.scans.find(s => s.id === scanId);
  if (!scan) return;
  const msg = scan.error_message || scan.skip_reason || 'No details available';
  toast(msg, scan.status === 'failed' ? 'error' : 'info');
}

// --- Format helpers ---
function fmtDuration(scan) {
  if (!scan.started_at || !scan.completed_at) return '-';
  const ms = new Date(scan.completed_at) - new Date(scan.started_at);
  return ms < 1000 ? `${ms}ms` : `${(ms / 1000).toFixed(1)}s`;
}

function fmtDate(iso) {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' +
    d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function fmtBbox(scan) {
  if (scan.bbox_width_m == null || scan.bbox_height_m == null) return '-';
  return `${Math.round(scan.bbox_width_m)}x${Math.round(scan.bbox_height_m)}m`;
}

function fmtBins(scan) {
  if (scan.bin_present === true) return '<span class="text-green-400 font-bold">&#10003;</span>';
  if (scan.bin_present === false) return '<span class="text-gray-500">&#10007;</span>';
  return '<span class="text-gray-600">-</span>';
}

function fmtBinQty(scan) {
  if (scan.bin_count == null) return '-';
  if (scan.bin_count === 0) return '0';
  const f = scan.bin_filled_count || 0;
  const e = scan.bin_empty_count || 0;
  return `${scan.bin_count} <span class="text-gray-500">(${f}F/${e}E)</span>`;
}

function fmtBinConf(scan) {
  if (scan.bin_confidence == null) return '-';
  return `${scan.bin_confidence}%`;
}

function fmtSearchLink(scan) {
  const parts = [scan.facility_name, scan.facility_address].filter(Boolean);
  if (parts.length === 0) return '-';
  const q = encodeURIComponent(parts.join(' '));
  return `<a href="https://www.google.com/maps/search/${q}" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="text-blue-400 hover:text-blue-300 underline">GMaps</a>`;
}


function fmtAI(scan) {
  if (scan.ai_validated === true) return '<span class="text-green-400 font-bold">&#10003;</span>';
  if (scan.ai_validated === false) return '<span class="text-red-400 font-bold">&#10007;</span>';
  return '<span class="text-gray-600">-</span>';
}

function fmtMethod(m, lat, lng) {
  if (!m) return '-';
  const label = m.replace(/_/g, ' ');
  if (m === 'msft_buildings' && lat != null && lng != null) {
    const url = `https://planetarycomputer.microsoft.com/explore?c=${encodeURIComponent(lng + ',' + lat)}&z=17&v=2&d=ms-buildings&m=Global&r=Default&s=false%3A%3A100%3A%3Atrue&sr=desc&ae=0`;
    return `<a href="${url}" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="text-blue-400 hover:text-blue-300 underline" title="View on Microsoft Planetary Computer">${label}</a>`;
  }
  return label;
}

function fmtCoords(scan) {
  if (scan.facility_lat == null || scan.facility_lng == null) return '-';
  const viewLink = `<a href="https://www.google.com/maps/@${scan.facility_lat.toFixed(6)},${scan.facility_lng.toFixed(6)},18z" target="_blank" rel="noopener" onclick="event.stopPropagation()" class="text-blue-400 hover:text-blue-300 underline">View</a>`;
  return `<div class="leading-tight"><div>${scan.facility_lat.toFixed(6)}</div><div>${scan.facility_lng.toFixed(6)}</div><div>${viewLink}</div></div>`;
}


// --- Sorting ---
function getSortValue(scan, field, idx) {
  switch (field) {
    case 'index': return idx;
    case 'facility_name': return (scan.facility_name || '').toLowerCase();
    case 'facility_address': return (scan.facility_address || '').toLowerCase();
    case 'status': return scan.status || '';
    case 'method': return scan.method || '';
    case 'ai_facility_type': return (scan.ai_facility_type || '').toLowerCase();
    case 'bbox': return (scan.bbox_width_m || 0) * (scan.bbox_height_m || 0);
    case 'started_at': return scan.started_at ? new Date(scan.started_at).getTime() : 0;
    default: return '';
  }
}

function sortScans(scans) {
  if (!S.sortField) return scans;
  const sorted = scans.map((s, i) => ({ s, i }));
  sorted.sort((a, b) => {
    const va = getSortValue(a.s, S.sortField, a.i);
    const vb = getSortValue(b.s, S.sortField, b.i);
    let cmp = 0;
    if (typeof va === 'number' && typeof vb === 'number') cmp = va - vb;
    else cmp = String(va).localeCompare(String(vb));
    return S.sortDir === 'asc' ? cmp : -cmp;
  });
  return sorted.map(x => x.s);
}

// --- Render table ---
function renderTable() {
  const tbody = document.getElementById('scan-tbody');
  const empty = document.getElementById('empty-state');
  const loading = document.getElementById('loading-state');
  loading.classList.add('hidden');

  const sorted = sortScans(S.scans);

  if (sorted.length === 0) {
    tbody.innerHTML = '';
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');

  // Build display order: grouped by company or flat
  // In grouped mode, hide sort indicators since grouping overrides column sort
  if (S.groupByCompany) {
    document.querySelectorAll('th[data-sort]').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
  } else if (S.sortField) {
    document.querySelectorAll('th[data-sort]').forEach(h => {
      h.classList.remove('sort-asc', 'sort-desc');
      if (h.dataset.sort === S.sortField) h.classList.add(S.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
    });
  }

  let displayScans;
  if (S.groupByCompany) {
    displayScans = [...sorted].sort((a, b) => {
      const nameA = (a.facility_name || '').toLowerCase();
      const nameB = (b.facility_name || '').toLowerCase();
      if (nameA < nameB) return -1;
      if (nameA > nameB) return 1;
      // Within same company, sort by date descending
      const dateA = a.started_at ? new Date(a.started_at).getTime() : 0;
      const dateB = b.started_at ? new Date(b.started_at).getTime() : 0;
      return dateB - dateA;
    });
  } else {
    displayScans = sorted;
  }

  let html = '';
  let currentGroup = null;
  displayScans.forEach((scan, i) => {
    // Emit group header when company name changes (grouped mode only)
    if (S.groupByCompany) {
      const groupKey = (scan.facility_name || '-').toLowerCase();
      if (groupKey !== currentGroup) {
        currentGroup = groupKey;
        const collapsed = S.collapsedGroups.has(groupKey);
        const chevron = collapsed ? '\u25B6' : '\u25BC';
        // Count facilities in this group
        const groupScans = displayScans.filter(s => (s.facility_name || '-').toLowerCase() === groupKey);
        const groupCount = groupScans.length;
        const groupDomain = groupScans.find(s => s.domain)?.domain || '';
        const anyBins = groupScans.some(s => s.bin_present === true);
        const allPending = groupScans.every(s => !s.bin_present && s.status !== 'completed');
        const binIcon = allPending ? '' : anyBins
          ? '<span class="text-green-400 ml-2" title="Bins found">&#10003;</span>'
          : '<span class="text-red-400 ml-2" title="No bins found">&#10007;</span>';
        html += `<tr class="bg-gray-800/70 border-l-2 border-blue-500 cursor-pointer hover:bg-gray-700/70 transition" data-group="${escAttr(groupKey)}">
          <td colspan="11" class="px-3 py-2">
            <span class="text-gray-500 text-xs mr-1">${chevron}</span>
            <span class="font-bold text-gray-200">${esc(scan.facility_name || '-')}</span>${binIcon}
            <span class="text-gray-500 text-xs ml-2">${groupCount} facilit${groupCount === 1 ? 'y' : 'ies'}</span>
            ${groupDomain ? `<span class="text-gray-600 text-xs ml-2">${esc(groupDomain)}</span>` : ''}
          </td>
        </tr>`;
      }
      // Skip facility rows if group is collapsed
      if (S.collapsedGroups.has(groupKey)) return;
    }

    const rowNum = S.offset + i + 1;
    const isOpen = S.expandedOpen[scan.id];
    const checked = S.selected.has(scan.id) ? 'checked' : '';
    html += `<tr class="border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer transition" data-id="${scan.id}">
      <td class="px-3 py-2" onclick="event.stopPropagation()"><input type="checkbox" class="row-check rounded bg-gray-800 border-gray-600 cursor-pointer" data-id="${scan.id}" ${checked}></td>
      <td class="px-3 py-2 text-gray-500">${rowNum}</td>
      <td class="px-3 py-2">
        <div class="font-medium">${esc(scan.facility_name || '-')}</div>
        <div class="text-gray-400 truncate max-w-[14rem]" title="${esc(scan.facility_address || '')}">${esc(scan.facility_address || '-')}</div>
        ${scan.domain ? `<div class="text-gray-400 truncate max-w-[14rem]"><a href="${escAttr(scan.domain.match(/^https?:\/\//) ? scan.domain : 'https://' + scan.domain)}" target="_blank" rel="noopener" class="text-gray-400 hover:text-gray-300 no-underline" onclick="event.stopPropagation()">${esc(scan.domain)}</a></div>` : ''}
      </td>
      <td class="px-3 py-2 text-center whitespace-nowrap">${fmtSearchLink(scan)}</td>
      <td class="px-3 py-2">${statusBadge(scan, scan.id)}</td>
      <td class="px-3 py-2 text-gray-400 text-xs font-mono whitespace-nowrap">${fmtCoords(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${fmtBbox(scan)}</td>
      <td class="px-3 py-2 text-center whitespace-nowrap">${fmtBins(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap text-center">${fmtBinQty(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap text-center">${fmtBinConf(scan)}</td>
      <td class="px-3 py-2 text-gray-400 whitespace-nowrap">${fmtDate(scan.started_at)}</td>
    </tr>`;
    if (isOpen) {
      html += `<tr class="border-b border-gray-800 bg-gray-800/30"><td colspan="11" class="px-4 py-3">`;
      html += renderDetail(scan);
      html += `</td></tr>`;
    }
  });
  // Snapshot open <details> inside expanded rows before DOM replacement
  const openDetails = new Map();
  tbody.querySelectorAll('tr[data-id]').forEach(row => {
    const id = row.dataset.id;
    if (!S.expandedOpen[id]) return;
    const next = row.nextElementSibling;
    if (!next) return;
    const indices = [];
    next.querySelectorAll('details').forEach((d, i) => { if (d.open) indices.push(i); });
    if (indices.length) openDetails.set(id, indices);
  });

  tbody.innerHTML = html;

  // Restore open <details> state after DOM rebuild
  if (openDetails.size) {
    tbody.querySelectorAll('tr[data-id]').forEach(row => {
      const id = row.dataset.id;
      const indices = openDetails.get(id);
      if (!indices) return;
      const next = row.nextElementSibling;
      if (!next) return;
      const details = next.querySelectorAll('details');
      indices.forEach(i => { if (details[i]) details[i].open = true; });
    });
  }

  tbody.querySelectorAll('tr[data-id]').forEach(row => {
    row.addEventListener('click', () => {
      const sel = window.getSelection();
      if (sel && sel.toString().length > 0) return;
      toggleRow(row.dataset.id);
    });
  });

  // Group header collapse/expand handlers
  tbody.querySelectorAll('tr[data-group]').forEach(row => {
    row.addEventListener('click', () => {
      const groupKey = row.dataset.group;
      if (S.collapsedGroups.has(groupKey)) S.collapsedGroups.delete(groupKey);
      else S.collapsedGroups.add(groupKey);
      renderTable();
    });
  });

  // Checkbox handlers (with shift-click range selection)
  const checkboxes = [...tbody.querySelectorAll('.row-check')];
  checkboxes.forEach((cb, idx) => {
    cb.addEventListener('click', (e) => {
      if (e.shiftKey && S.lastCheckedIdx !== null) {
        const from = Math.min(S.lastCheckedIdx, idx);
        const to = Math.max(S.lastCheckedIdx, idx);
        const checked = cb.checked;
        for (let i = from; i <= to; i++) {
          checkboxes[i].checked = checked;
          if (checked) S.selected.add(checkboxes[i].dataset.id);
          else S.selected.delete(checkboxes[i].dataset.id);
        }
      } else {
        if (cb.checked) S.selected.add(cb.dataset.id);
        else S.selected.delete(cb.dataset.id);
      }
      S.lastCheckedIdx = idx;
      updateSelectionBtns();
    });
  });

  // Sync select-all state
  const selectAll = document.getElementById('select-all');
  if (selectAll) {
    selectAll.checked = sorted.length > 0 && sorted.every(s => S.selected.has(s.id));
    selectAll.indeterminate = sorted.some(s => S.selected.has(s.id)) && !selectAll.checked;
  }

  // Update stats
  const completedCount = sorted.filter(s => s.status === 'completed').length;
  const binsFoundCount = sorted.filter(s => s.bin_present === true).length;
  document.getElementById('stat-total').textContent = sorted.length;
  document.getElementById('stat-completed').textContent = completedCount;
  document.getElementById('stat-bins').textContent = binsFoundCount;

  document.getElementById('prev-btn').disabled = S.offset === 0;
  document.getElementById('next-btn').disabled = sorted.length < S.limit;
  const page = Math.floor(S.offset / S.limit) + 1;
  document.getElementById('page-info').textContent = `Page ${page}`;
}

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}
function escAttr(str) {
  return str.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// --- Image modal ---
function openImageModal(url, label, overlayData, msftData) {
  const modal = document.getElementById('image-modal');
  const img = document.getElementById('image-modal-img');
  const container = document.getElementById('image-modal-container');
  const caption = document.getElementById('image-modal-caption');

  // Clear previous overlays
  container.querySelectorAll('.boundary-overlay').forEach(el => el.remove());
  container.querySelectorAll('.msft-overlay').forEach(el => el.remove());

  img.onload = null;
  img.src = url;

  // Caption with direct link
  let captionHtml = `<span>${esc(label)}</span>`;
  captionHtml += ` &mdash; <a href="${url}" target="_blank" rel="noopener" class="text-blue-400 hover:text-blue-300 underline">Open original in new tab ↗</a>`;
  caption.innerHTML = captionHtml;

  if (overlayData || msftData) {
    img.onload = function() {
      if (overlayData) drawBoundaryOverlay(img, overlayData.bbox, overlayData.origW, overlayData.origH);
      if (msftData) drawMsftOverlay(img, msftData.polygons, msftData.origW, msftData.origH, msftData.targetMask);
    };
  }

  modal.classList.remove('hidden');
  document.addEventListener('keydown', imageModalEscHandler);
}

function closeImageModal() {
  const modal = document.getElementById('image-modal');
  modal.classList.add('hidden');
  document.getElementById('image-modal-img').src = '';
  document.removeEventListener('keydown', imageModalEscHandler);
}

function imageModalEscHandler(e) {
  if (e.key === 'Escape') closeImageModal();
}

// --- Boundary overlay ---
function drawBoundaryOverlay(imgEl, pixelBbox, origWidth, origHeight) {
  const container = imgEl.closest('.bbox-overlay-container');
  if (!container) return;
  // Remove any existing overlays
  container.querySelectorAll('.boundary-overlay').forEach(el => el.remove());

  const renderedW = imgEl.clientWidth;
  const renderedH = imgEl.clientHeight;
  if (!renderedW || !renderedH) return;

  const scaleX = renderedW / origWidth;
  const scaleY = renderedH / origHeight;

  const left = pixelBbox.left_x * scaleX;
  const top = pixelBbox.top_y * scaleY;
  const width = (pixelBbox.right_x - pixelBbox.left_x) * scaleX;
  const height = (pixelBbox.bottom_y - pixelBbox.top_y) * scaleY;

  const overlay = document.createElement('div');
  overlay.className = 'boundary-overlay';
  overlay.style.left = left + 'px';
  overlay.style.top = top + 'px';
  overlay.style.width = width + 'px';
  overlay.style.height = height + 'px';
  overlay.title = `AI boundary: ${pixelBbox.left_x},${pixelBbox.top_y} → ${pixelBbox.right_x},${pixelBbox.bottom_y}`;
  container.appendChild(overlay);
}

// --- MSFT polygon overlay ---
function drawMsftOverlay(imgEl, polygons, origWidth, origHeight, targetMask) {
  const container = imgEl.closest('.bbox-overlay-container');
  if (!container) return;
  container.querySelectorAll('.msft-overlay').forEach(el => el.remove());

  const rW = imgEl.clientWidth, rH = imgEl.clientHeight;
  if (!rW || !rH) return;
  const scaleX = rW / origWidth, scaleY = rH / origHeight;
  const mask = targetMask || [];

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'msft-overlay');
  svg.setAttribute('width', rW);
  svg.setAttribute('height', rH);

  polygons.forEach((pts, i) => {
    const isTarget = mask[i] === true;
    const points = pts.map(([x, y]) => `${x * scaleX},${y * scaleY}`).join(' ');
    const pg = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
    pg.setAttribute('points', points);
    if (isTarget) {
      pg.setAttribute('fill', 'rgba(0,200,80,0.2)');
      pg.setAttribute('stroke', 'rgba(0,200,80,0.9)');
      pg.setAttribute('stroke-width', '2');
    } else {
      pg.setAttribute('fill', 'rgba(0,120,255,0.2)');
      pg.setAttribute('stroke', 'rgba(0,120,255,0.35)');
      pg.setAttribute('stroke-width', '1');
    }
    svg.appendChild(pg);
  });

  container.appendChild(svg);
}

// --- Detail panel ---
function renderDetail(scan) {
  const trace = S.expanded[scan.id];
  let html = '<div class="space-y-4">';

  if (scan.screenshots && scan.screenshots.length > 0) {
    const ssOrder = { overview: 0, ai_overview: 1, final: 2, bin_chunk: 3, msft_overlay: 4 };
    const sorted = [...scan.screenshots].sort((a, b) => (ssOrder[a.type] ?? 99) - (ssOrder[b.type] ?? 99));
    html += '<div class="flex flex-wrap gap-3">';
    sorted.forEach(ss => {
      const sizeParts = [];
      if (ss.width && ss.height) sizeParts.push(`${ss.width}×${ss.height}px`);
      if (ss.file_size_bytes) sizeParts.push(`${(ss.file_size_bytes / 1048576).toFixed(2)} MB`);
      const sizeStr = sizeParts.length ? ` — ${sizeParts.join(', ')}` : '';

      // Check for AI boundary overlay on ai_overview screenshots
      let overlayData = null;
      if (ss.type === 'ai_overview' && trace && trace.steps) {
        const visionStep = trace.steps.find(s => s.step_name === 'ai_vision');
        if (visionStep && visionStep.output_summary && visionStep.output_summary.pixel_bbox) {
          const pb = visionStep.output_summary.pixel_bbox;
          const dimStr = visionStep.input_summary && visionStep.input_summary.overview_image;
          const dimMatch = dimStr ? dimStr.match(/(\d+)x(\d+)/) : null;
          if (dimMatch) {
            overlayData = { bbox: pb, origW: parseInt(dimMatch[1]), origH: parseInt(dimMatch[2]) };
          }
        }
      }

      // Check for MSFT polygon overlay on overview screenshots
      let msftData = null;
      if (ss.type === 'overview' && trace && trace.steps) {
        const valStep = trace.steps.find(s => s.step_name === 'ai_validation');
        if (valStep && valStep.input_summary && valStep.input_summary.msft_polygons_px) {
          const dimStr = valStep.input_summary.overview_image;
          const dimMatch = dimStr ? dimStr.match(/(\d+)x(\d+)/) : null;
          if (dimMatch) {
            msftData = {
              polygons: valStep.input_summary.msft_polygons_px,
              origW: parseInt(dimMatch[1]),
              origH: parseInt(dimMatch[2]),
              targetMask: valStep.input_summary.msft_target_mask || []
            };
          }
        }
      }

      // For bin_chunk screenshots, extract col/row and look up chunk result stats
      let typeLabel = ss.type;
      let chunkInfo = null;
      if (ss.type === 'bin_chunk' && ss.filename) {
        const m = ss.filename.match(/bin_chunk_(\d+)_(\d+)/);
        if (m) {
          const col = parseInt(m[1]), row = parseInt(m[2]);
          typeLabel = `c${col}r${row}`;
          // Find chunk result from bin_detection step
          if (trace && trace.steps) {
            const binStep = trace.steps.find(s => s.step_name === 'bin_detection');
            const chunkResults = binStep?.output_summary?.chunk_results || [];
            const cr = chunkResults.find(c => c.col === col && c.row === row);
            if (cr) chunkInfo = { bins: cr.total_bins || 0, confidence: cr.overall_confidence || 0 };
          }
        }
      }
      const label = `${typeLabel} (z${ss.zoom || '?'})${sizeStr}`;
      const overlayArg = overlayData ? JSON.stringify(overlayData).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : 'null';
      const msftArg = msftData ? JSON.stringify(msftData).replace(/"/g, '&quot;').replace(/'/g, '&#39;') : 'null';

      const thumbSrc = ss.thumb_url || ss.url;
      if (overlayData || msftData) {
        let onloadCalls = '';
        if (overlayData) {
          const bboxJson = JSON.stringify(overlayData.bbox).replace(/"/g, '&quot;');
          onloadCalls += `drawBoundaryOverlay(this, ${bboxJson}, ${overlayData.origW}, ${overlayData.origH});`;
        }
        if (msftData) {
          const msftJson = JSON.stringify(msftData.polygons).replace(/"/g, '&quot;');
          const maskJson = JSON.stringify(msftData.targetMask || []).replace(/"/g, '&quot;');
          onloadCalls += `drawMsftOverlay(this, ${msftJson}, ${msftData.origW}, ${msftData.origH}, ${maskJson});`;
        }
        let badges = '';
        if (overlayData) badges += ' <span class="text-red-400">■</span> AI boundary';
        if (msftData) badges += ' <span class="text-green-400">■</span> target <span class="text-blue-400">■</span> context';
        html += `<div class="text-center">
          <div class="relative inline-block bbox-overlay-container cursor-pointer" onclick="openImageModal('${ss.url}', '${esc(label)}', ${overlayArg}, ${msftArg})" title="Click to enlarge">
              <img src="${thumbSrc}" alt="${esc(typeLabel)}" class="rounded border border-gray-700 max-h-48 object-contain cursor-pointer hover:border-blue-500 transition-colors"
                onload="${onloadCalls}">
          </div>
          <div class="text-xs text-gray-500 mt-1">${esc(typeLabel)} (z${ss.zoom || '?'})${sizeStr}${badges ? '<br>' + badges : ''}</div>
        </div>`;
      } else {
        let chunkLabel = `<div class="text-xs text-gray-500 mt-1">${esc(typeLabel)} (z${ss.zoom || '?'})${sizeStr}</div>`;
        if (chunkInfo) {
          chunkLabel += `<div class="text-sm text-gray-300">${esc(typeLabel)} — ${chunkInfo.bins} bin${chunkInfo.bins !== 1 ? 's' : ''}, ${chunkInfo.confidence}% conf</div>`;
        }
        html += `<div class="text-center cursor-pointer" onclick="openImageModal('${ss.url}', '${esc(label)}', null, null)" title="Click to enlarge">
            <img src="${thumbSrc}" alt="${esc(typeLabel)}" class="rounded border border-gray-700 max-h-48 object-contain cursor-pointer hover:border-blue-500 transition-colors" loading="lazy">
          ${chunkLabel}
        </div>`;
      }
    });
    html += '</div>';
  }

  if (trace && trace.steps) {
    // Split steps into pipeline (1-6) and bin detection (7-8)
    const pipelineSteps = trace.steps.filter(s => !['image_chunking', 'bin_detection'].includes(s.step_name));
    const binSteps = trace.steps.filter(s => ['image_chunking', 'bin_detection'].includes(s.step_name));

    // --- Pipeline Trace (steps 1-6) ---
    if (pipelineSteps.length > 0) {
    html += '<details class="text-xs">';
    html += '<summary class="text-xs font-semibold uppercase tracking-wide text-gray-400 cursor-pointer hover:text-gray-300">Pipeline Trace</summary>';
    html += '<div class="space-y-2 mt-2">';
    pipelineSteps.forEach(step => {
      const dur = step.duration_ms != null ? `(${(step.duration_ms / 1000).toFixed(1)}s)` : '';
      const dec = step.decision || '';
      const stepColor = step.status === 'failed' ? 'text-red-400' : 'text-green-400';
      const stepTime = step.completed_at ? fmtDate(step.completed_at) : (step.started_at ? fmtDate(step.started_at) : '');
      html += `<div class="bg-gray-900 rounded px-3 py-2 text-sm">
        <div class="flex items-center gap-2">
          <span class="text-gray-500">Step ${step.step_number}:</span>
          <span class="font-medium">${esc(step.step_name.replace(/_/g, ' '))}</span>
          <span class="text-gray-500">${dur}</span>
          ${stepTime ? `<span class="text-gray-600 text-xs ml-auto">${stepTime}</span>` : ''}
        </div>
        <span class="${stepColor}"> &rarr; ${esc(dec)}</span>`;

      if (step.ai_tokens_total) {
        html += `<div class="text-xs text-gray-500 mt-1 ml-4">
          Model: <span class="text-gray-300">${esc(step.ai_model || '?')}</span> |
          Tokens: <span class="text-gray-300">${step.ai_tokens_total.toLocaleString()}</span>
          (${(step.ai_tokens_prompt || 0).toLocaleString()}p + ${(step.ai_tokens_completion || 0).toLocaleString()}c${step.ai_tokens_reasoning ? ' + ' + step.ai_tokens_reasoning.toLocaleString() + 'r' : ''})
        </div>`;
      }

      if (step.tile_grid_cols && step.tile_grid_rows) {
        const total = step.tile_grid_cols * step.tile_grid_rows;
        html += `<div class="text-xs text-gray-500 mt-1 ml-4">
          Grid: ${step.tile_grid_cols}x${step.tile_grid_rows} = ${total} tiles
        </div>`;
      }

      // AI Vision step: show verification, retries, reasoning, and raw AI response dropdowns
      if (step.step_name === 'ai_vision' && step.output_summary) {
        const out = step.output_summary;
        html += '<div class="mt-2 ml-4 space-y-1">';

        // Reasoning dropdown (from self-check)
        if (out.reasoning || out.self_check) {
          html += `<details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Reasoning &amp; Self-Check</summary>
            <div class="mt-1 bg-gray-950 rounded p-2 text-gray-400 space-y-1">`;
          if (out.reasoning) html += `<div><span class="text-gray-500">Reasoning:</span> ${esc(out.reasoning)}</div>`;
          if (out.self_check) html += `<div><span class="text-gray-500">Self-check:</span> ${esc(out.self_check)}</div>`;
          html += '</div></details>';
        }

        // Final Verification dropdown (the last verification result)
        if (out.verification) {
          const v = out.verification;
          const vStatus = v.error ? 'Error' : (v.approved ? 'Approved' : 'Rejected');
          const vColor = v.error ? 'text-yellow-400' : (v.approved ? 'text-green-400' : 'text-red-400');
          const vLabel = (out.retry_count > 0) ? 'Final Verification' : 'Verification';
          html += `<details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">${vLabel}: <span class="${vColor}">${vStatus}</span></summary>
            <div class="mt-1 bg-gray-950 rounded p-2 text-gray-400 space-y-1">`;
          if (v.error) {
            html += `<div>Error: ${esc(v.error)}</div>`;
          } else {
            html += `<div>Approved: <span class="${vColor} font-medium">${v.approved}</span></div>`;
            html += `<div>Reason: ${esc(v.reason || '-')}</div>`;
            html += `<div>Issues: ${esc(v.issues || '-')}</div>`;
            if (v.tokens) html += `<div>Tokens: ${(v.tokens.total || 0).toLocaleString()} (${(v.tokens.prompt || 0).toLocaleString()}p + ${(v.tokens.completion || 0).toLocaleString()}c)</div>`;
          }
          html += '</div></details>';
        }

        // Retries list (each rejected attempt with boundary + verification)
        if (out.retries && out.retries.length > 0) {
          out.retries.forEach(r => {
            const rv = r.verification;
            const rb = r.boundary;
            html += `<details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Rejected Attempt ${r.attempt}: <span class="text-red-400">${esc(rv.reason || 'rejected')}</span></summary>
              <div class="mt-1 bg-gray-950 rounded p-2 text-gray-400 space-y-1">`;
            // Boundary info
            if (rb.pixel_bbox) html += `<div>Pixel bbox: (${rb.pixel_bbox.left_x}, ${rb.pixel_bbox.top_y}) → (${rb.pixel_bbox.right_x}, ${rb.pixel_bbox.bottom_y})</div>`;
            html += `<div>Confidence: ${esc(rb.confidence || '-')}</div>`;
            html += `<div>Type: ${esc(rb.facility_type || '-')}</div>`;
            html += `<div>Buildings: ${rb.building_count ?? '-'}</div>`;
            if (rb.reasoning) html += `<div>Reasoning: ${esc(rb.reasoning)}</div>`;
            if (rb.self_check) html += `<div>Self-check: ${esc(rb.self_check)}</div>`;
            if (rb.notes) html += `<div>Notes: ${esc(rb.notes)}</div>`;
            if (rb.tokens) html += `<div>Boundary tokens: ${(rb.tokens.total || 0).toLocaleString()}</div>`;
            // Verification info
            html += `<div class="border-t border-gray-800 mt-1 pt-1">`;
            html += `<div>Rejection reason: ${esc(rv.reason || '-')}</div>`;
            html += `<div>Issues: ${esc(rv.issues || '-')}</div>`;
            if (rv.edge_feedback) {
              html += `<div class="mt-1 text-gray-500">Per-edge feedback:</div>`;
              Object.entries(rv.edge_feedback).forEach(([edge, fb]) => {
                html += `<div class="ml-2">• ${esc(edge.toUpperCase())}: ${esc(String(fb))}</div>`;
              });
            }
            if (rv.tokens) html += `<div>Verification tokens: ${(rv.tokens.total || 0).toLocaleString()}</div>`;
            html += '</div>';
            html += '</div></details>';
          });
        }

        // Raw AI Response dropdown (final boundary response)
        if (step.ai_response_raw) {
          html += `<details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Boundary AI Response (raw)</summary>
            <pre class="mt-1 bg-gray-950 rounded p-2 text-gray-400 overflow-x-auto max-h-48">${esc(step.ai_response_raw)}</pre></details>`;
        }

        html += '</div>';
      }

      // AI Validation step: show raw AI response dropdown
      if (step.step_name === 'ai_validation' && step.ai_response_raw) {
        html += `<div class="mt-2 ml-4">
          <details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Validation AI Response (raw)</summary>
            <pre class="mt-1 bg-gray-950 rounded p-2 text-gray-400 overflow-x-auto max-h-48">${esc(step.ai_response_raw)}</pre></details>
        </div>`;
      }

      html += '</div>';
    });

    if (trace.total_ai_tokens) {
      html += `<div class="text-xs text-gray-400 mt-1">Total AI tokens: <span class="text-gray-200 font-medium">${trace.total_ai_tokens.toLocaleString()}</span></div>`;
    }
    html += '</div></details>';
    }

    // --- Bin Detection Trace (steps 7-8) ---
    if (binSteps.length > 0) {
      const chunkingStep = binSteps.find(s => s.step_name === 'image_chunking');
      const binStep = binSteps.find(s => s.step_name === 'bin_detection');

      // Extract grid info from image_chunking step
      const chunkOut = chunkingStep && chunkingStep.output_summary ? chunkingStep.output_summary : {};
      const gridLabel = chunkOut.grid || '?';
      const chunkCount = chunkOut.chunk_count || 0;
      const chunkInput = chunkingStep && chunkingStep.input_summary ? chunkingStep.input_summary : {};
      const maxChunkM = chunkInput.max_chunk_m || '?';

      // Extract bin detection info
      const binOut = binStep && binStep.output_summary ? binStep.output_summary : {};
      const binIn = binStep && binStep.input_summary ? binStep.input_summary : {};
      const chunkResults = binOut.chunk_results || [];
      const totalBins = binOut.total_bins || 0;
      const binTokensTotal = binStep ? (binStep.ai_tokens_total || 0) : 0;
      const minConfidence = parseInt(S.settings.bin_detection_min_confidence) || binIn.min_confidence || 50;
      const binDur = binStep && binStep.duration_ms != null ? (binStep.duration_ms / 1000).toFixed(1) : '?';
      const binModel = binStep ? (binStep.ai_model || '?') : '?';
      const bds = scan.bin_detection_status;
      const bdsColor = bds === 'completed' ? 'text-green-400' : bds === 'partial' ? 'text-yellow-400' : bds === 'failed' ? 'text-red-400' : 'text-gray-400';

      html += '<details class="text-xs" open>';
      html += '<summary class="text-xs font-semibold uppercase tracking-wide text-gray-400 cursor-pointer hover:text-gray-300">Bin Detection Trace</summary>';
      html += '<div class="space-y-2 mt-2">';

      // Header: grid summary + overall stats + bin summary (replaces standalone bin detection summary)
      html += '<div class="bg-gray-900 rounded px-3 py-2 text-sm">';
      html += `<div class="flex items-center gap-3 flex-wrap">`;
      html += `<span class="text-gray-300">Grid: <span class="text-gray-100 font-medium">${esc(gridLabel)}</span> = ${chunkCount} chunks (${esc(String(maxChunkM))}m)</span>`;
      html += `<span class="text-gray-500">|</span>`;
      if (totalBins > 0) {
        html += `<span class="text-green-400 font-medium">&#10003; ${totalBins} bin${totalBins !== 1 ? 's' : ''} detected</span>`;
      } else {
        html += `<span class="text-gray-500">0 bins detected</span>`;
      }
      html += `<span class="text-gray-500">|</span>`;
      html += `<span class="text-gray-300">${binTokensTotal.toLocaleString()} tokens</span>`;
      html += `<span class="text-gray-500">|</span>`;
      html += `<span class="text-gray-300">${binDur}s</span>`;
      html += `<span class="text-gray-500">|</span>`;
      html += `<span class="text-gray-300">Model: ${esc(binModel)}</span>`;
      html += `<span class="text-gray-500">|</span>`;
      html += `<span class="${bdsColor}">${esc(bds || 'unknown')}</span>`;
      html += '</div>';
      if (scan.bin_present) {
        html += `<div class="mt-1 flex items-center gap-4 flex-wrap">`;
        html += `<span class="text-yellow-400">Filled: <span class="font-medium">${scan.bin_filled_count || 0}</span></span>`;
        html += `<span class="text-gray-400">Empty: <span class="font-medium">${scan.bin_empty_count || 0}</span></span>`;
        html += `<span class="text-gray-300">Confidence: <span class="font-medium">${scan.bin_confidence}%</span></span>`;
        html += `</div>`;
      } else if (bds) {
        html += '<div class="mt-1 text-gray-500">No bins detected</div>';
      }
      html += '</div>';

      // Per-chunk rows
      chunkResults.forEach(cr => {
        const label = `c${cr.col}r${cr.row}`;
        if (cr.status === 'failed') {
          // Failed chunk
          html += `<details class="text-xs">`;
          html += `<summary class="cursor-pointer hover:text-gray-300 text-gray-400 bg-gray-900 rounded px-3 py-1">`;
          html += `<span class="text-red-400 font-medium">${esc(label)}: FAILED</span>`;
          html += `</summary>`;
          html += `<div class="mt-1 bg-gray-950 rounded p-2 text-red-400">Error: ${esc(cr.error || 'Unknown error')}</div>`;
          html += `</details>`;
          return;
        }

        // Successful chunk — use overall_confidence (min of per-bin confs, same as backend save gate)
        const crBins = cr.bins || [];
        const crReasoning = cr.reasoning || '';
        const crTokens = cr.total_tokens || 0;
        const crConf = cr.overall_confidence || 0;
        const binCountStr = cr.total_bins || 0;
        const crFilled = cr.filled_or_partial_count || 0;
        const crEmpty = cr.empty_or_unclear_count || 0;
        const hasBins = binCountStr > 0;
        const passesGate = hasBins && crConf >= minConfidence;

        html += `<details class="text-xs">`;
        html += `<summary class="cursor-pointer hover:text-gray-300 text-gray-400 bg-gray-900 rounded px-3 py-1">`;
        html += `<span class="font-medium ${passesGate ? 'text-green-400' : hasBins ? 'text-yellow-600' : 'text-gray-300'}">${esc(label)}</span>: `;
        if (hasBins) {
          html += `<span class="text-gray-300">${binCountStr} bin${binCountStr !== 1 ? 's' : ''}</span>`;
          html += ` <span class="text-yellow-400">${crFilled}F</span>`;
          html += ` <span class="text-gray-500">${crEmpty}E</span>`;
          html += ` <span class="${passesGate ? 'text-gray-300' : 'text-yellow-600'}">conf ${crConf}%</span>`;
          if (!passesGate) html += ` <span class="text-yellow-700">(below ${minConfidence}%)</span>`;
        } else {
          html += `<span class="text-gray-500">0 bins</span>`;
        }
        html += ` — <span class="text-gray-500">${crTokens.toLocaleString()} tokens</span>`;
        html += `</summary>`;
        html += `<div class="mt-1 bg-gray-950 rounded p-3 text-gray-400 space-y-2">`;

        // Parsed AI output
        html += `<div>bin_present: <span class="${cr.bin_present ? 'text-green-400' : 'text-gray-500'}">${cr.bin_present}</span></div>`;
        html += `<div>total_bins: ${cr.total_bins || 0}</div>`;

        // Per-bin details
        if (crBins.length > 0) {
          crBins.forEach((bin, i) => {
            html += `<div class="border-l-2 border-gray-700 pl-3 ml-1">`;
            html += `<div class="text-gray-300 font-medium">Bin ${i + 1}:</div>`;
            html += `<div>region: ${esc(bin.region || '-')}, fill: <span class="${bin.fill_status === 'filled_or_partial' ? 'text-yellow-400' : 'text-gray-500'}">${esc(bin.fill_status || '-')}</span>, conf: ${bin.confidence || 0}%</div>`;
            if (bin.evidence) html += `<div class="text-gray-500 italic">evidence: "${esc(bin.evidence)}"</div>`;
            html += `</div>`;
          });
        }

        // Reasoning paragraph
        const reasoning = cr.reasoning || '';
        const reasoningStr = Array.isArray(reasoning) ? reasoning.join(' ') : (typeof reasoning === 'string' ? reasoning : '');
        if (reasoningStr.trim()) {
          html += `<div class="border-t border-gray-800 pt-1 mt-1">`;
          html += `<div class="text-gray-500 font-medium">Reasoning:</div>`;
          html += `<div class="ml-2 text-gray-400">${esc(reasoningStr)}</div>`;
          html += `</div>`;
        }

        // Raw AI Response (collapsible)
        if (cr.raw_response) {
          html += `<details class="text-xs border-t border-gray-800 pt-1 mt-1"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Raw AI Response</summary>`;
          html += `<pre class="mt-1 bg-gray-900 rounded p-2 text-gray-400 overflow-x-auto max-h-48 text-xs">${esc(cr.raw_response)}</pre></details>`;
        }

        // Token breakdown
        if (crTokens > 0) {
          html += `<div class="text-gray-600 text-xs">Tokens: ${(cr.prompt_tokens || 0).toLocaleString()}p + ${(cr.completion_tokens || 0).toLocaleString()}c = ${crTokens.toLocaleString()} total</div>`;
        }

        html += `</div></details>`;
      });

      // AI Prompt used (collapsible)
      if (binStep && binStep.ai_prompt) {
        html += `<details class="text-xs"><summary class="cursor-pointer hover:text-gray-300 text-gray-500">Bin Detection Prompt (click to view)</summary>`;
        html += `<pre class="mt-1 bg-gray-950 rounded p-2 text-gray-400 overflow-x-auto max-h-64 text-xs">${esc(binStep.ai_prompt)}</pre></details>`;
      }

      html += '</div></details>';
    }
  } else if (!trace) {
    // Auto-fetch trace if row is open but trace is missing (safety net)
    if (!S._fetchingTrace?.[scan.id]) {
      S._fetchingTrace = S._fetchingTrace || {};
      S._fetchingTrace[scan.id] = true;
      api('GET', `/api/scan/${scan.id}/steps`)
        .then(t => { S.expanded[scan.id] = t; delete S._fetchingTrace[scan.id]; renderTable(); })
        .catch(() => { S.expanded[scan.id] = { steps: [], error: 'Failed to load' }; delete S._fetchingTrace[scan.id]; renderTable(); });
    }
    html += '<div class="text-sm text-gray-500">Loading trace...</div>';
  }

  html += '<details class="text-xs"><summary class="text-gray-500 cursor-pointer hover:text-gray-300">Full Metadata</summary>';
  html += `<pre class="mt-2 bg-gray-950 rounded p-3 overflow-x-auto text-gray-400 max-h-64">${esc(JSON.stringify(scan, null, 2))}</pre>`;
  html += '</details>';

  html += '</div>';
  return html;
}

// --- Row expand/collapse ---
async function toggleRow(scanId) {
  if (S.expandedOpen[scanId]) {
    S.expandedOpen[scanId] = false;
    renderTable();
    return;
  }

  S.expandedOpen[scanId] = true;

  if (!S.expanded[scanId]) {
    renderTable();
    try {
      const trace = await api('GET', `/api/scan/${scanId}/steps`);
      S.expanded[scanId] = trace;
    } catch (e) {
      S.expanded[scanId] = { steps: [], error: e.message };
    }
  }
  renderTable();
}

// --- Selection / Delete / Scan ---
function updateSelectionBtns() {
  const count = S.selected.size;

  const delBtn = document.getElementById('delete-btn');
  if (!document.getElementById('delete-count')) {
    delBtn.innerHTML = 'Delete Selected (<span id="delete-count">0</span>)';
  }
  document.getElementById('delete-count').textContent = count;
  delBtn.disabled = count === 0;
  delBtn.classList.toggle('hidden', count === 0);

  const scanBtn = document.getElementById('scan-selected-btn');
  if (!document.getElementById('scan-selected-count')) {
    scanBtn.innerHTML = 'Scan Selected (<span id="scan-selected-count">0</span>)';
  }
  document.getElementById('scan-selected-count').textContent = count;
  scanBtn.disabled = count === 0;
  scanBtn.classList.toggle('hidden', count === 0);

  const binBtn = document.getElementById('detect-bins-btn');
  if (!document.getElementById('detect-bins-count')) {
    binBtn.innerHTML = 'Detect Bins (<span id="detect-bins-count">0</span>)';
  }
  document.getElementById('detect-bins-count').textContent = count;
  binBtn.disabled = count === 0;
  binBtn.classList.toggle('hidden', count === 0);
}

async function deleteSelected() {
  const ids = [...S.selected];
  if (ids.length === 0) return;
  if (!confirm(`Delete ${ids.length} scan${ids.length > 1 ? 's' : ''}? This cannot be undone.`)) return;

  const btn = document.getElementById('delete-btn');
  btn.disabled = true;
  btn.textContent = 'Deleting...';

  try {
    const res = await api('DELETE', '/api/scans', { scan_ids: ids });
    toast(`Deleted ${res.deleted} scan${res.deleted !== 1 ? 's' : ''}`);
    const deleted = new Set(ids);
    S.scans = S.scans.filter(s => !deleted.has(s.id));
    S.selected.clear();
    updateSelectionBtns();
    renderTable();
    fetchScans();
    fetchHealth();
  } catch (e) {
    toast('Delete failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Delete Selected (<span id="delete-count">0</span>)';
    updateSelectionBtns();
  }
}

async function scanSelected() {
  const ids = [...S.selected];
  if (ids.length === 0) return;

  const btn = document.getElementById('scan-selected-btn');
  btn.disabled = true;
  btn.textContent = 'Enqueuing...';

  try {
    const res = await api('POST', '/api/scans/enqueue', { scan_ids: ids });
    let msg = `Queued ${res.queued} scan${res.queued !== 1 ? 's' : ''}`;
    if (res.skipped_no_coords > 0) msg += ` (${res.skipped_no_coords} skipped — no coords)`;
    toast(msg);
    // Invalidate trace cache for re-queued scans
    ids.forEach(id => { delete S.expanded[id]; });
    S.selected.clear();
    updateSelectionBtns();
    fetchScans();
    fetchHealth();
  } catch (e) {
    toast('Enqueue failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Scan Selected (<span id="scan-selected-count">0</span>)';
    updateSelectionBtns();
  }
}

function detectBinsSelected() {
  const ids = [...S.selected];
  if (ids.length === 0) return;

  const btn = document.getElementById('detect-bins-btn');
  btn.disabled = true;
  btn.textContent = 'Detecting...';

  // Track detecting IDs in durable state (survives fetchScans replacing S.scans)
  ids.forEach(id => S._detectingIds.add(id));

  // Clear selection immediately so user can keep working
  S.selected.clear();
  updateSelectionBtns();
  renderTable();

  // Ensure polling is active to pick up intermediate changes
  if (!S.pollTimer) {
    S.pollTimer = setInterval(fetchScans, 5000);
  }

  // Fire-and-forget: API call runs in background
  api('POST', '/api/scans/detect-bins', { scan_ids: ids })
    .then(res => {
      let msg = `Bin detection: ${res.processed} processed`;
      if (res.skipped > 0) msg += `, ${res.skipped} skipped`;
      toast(msg);
      // Clear detecting flags and invalidate trace cache
      ids.forEach(id => {
        S._detectingIds.delete(id);
        delete S.expanded[id];
      });
      fetchScans();
    })
    .catch(e => {
      ids.forEach(id => S._detectingIds.delete(id));
      toast('Bin detection failed: ' + e.message, 'error');
      renderTable();
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerHTML = 'Detect Bins (<span id="detect-bins-count">0</span>)';
      updateSelectionBtns();
    });
}

async function scanAllPending() {
  const btn = document.getElementById('scan-pending-btn');
  btn.disabled = true;
  btn.textContent = 'Enqueuing...';

  try {
    const res = await api('POST', '/api/scans/enqueue-pending');
    let msg = `Queued ${res.queued} pending scan${res.queued !== 1 ? 's' : ''}`;
    if (res.skipped_no_coords > 0) msg += ` (${res.skipped_no_coords} skipped — no coords)`;
    toast(msg);
    // Invalidate all trace caches since we don't know which scans were pending
    S.expanded = {};
    fetchScans();
    fetchHealth();
  } catch (e) {
    toast('Enqueue failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Scan All Pending';
  }
}

// --- Fetch scans ---
async function fetchScans() {
  const params = new URLSearchParams();
  const bins = document.getElementById('filter-bins').value;
  const search = document.getElementById('search-input').value.trim();

  const status = document.getElementById('filter-status').value;
  if (status) params.set('status', status);
  if (bins) params.set('bins', bins);
  if (search) params.set('search', search);
  params.set('limit', S.limit);
  params.set('offset', S.offset);

  try {
    const newScans = await api('GET', `/api/scans?${params}`);
    // Invalidate trace cache for scans whose status or bin detection changed
    const oldMap = Object.fromEntries(S.scans.map(s => [s.id, { status: s.status, bin: s.bin_detection_status }]));
    newScans.forEach(s => {
      const old = oldMap[s.id];
      if (old && (old.status !== s.status || old.bin !== s.bin_detection_status)) {
        delete S.expanded[s.id];
        if (S.expandedOpen[s.id]) {
          api('GET', `/api/scan/${s.id}/steps`)
            .then(trace => { S.expanded[s.id] = trace; renderTable(); })
            .catch(e => { S.expanded[s.id] = { steps: [], error: e.message }; renderTable(); });
        }
      }
    });
    const oldScans = S.scans;
    S.scans = newScans;
    const changed = newScans.length !== oldScans.length ||
      newScans.some((s, i) => s.id !== oldScans[i]?.id || s.status !== oldScans[i]?.status || s.bin_detection_status !== oldScans[i]?.bin_detection_status || s.bin_count !== oldScans[i]?.bin_count);
    if (changed) renderTable();
    managePoll();
  } catch (e) {
    toast('Failed to load scans: ' + e.message, 'error');
  }
}

// --- Polling ---
const TERMINAL = new Set(['completed', 'failed', 'skipped', 'pending']);

function managePoll() {
  const hasActive = S.scans.some(s => !TERMINAL.has(s.status)) || S._detectingIds.size > 0;
  if (hasActive && !S.pollTimer) {
    S.pollTimer = setInterval(fetchScans, 5000);
  } else if (!hasActive && S.pollTimer) {
    clearInterval(S.pollTimer);
    S.pollTimer = null;
  }
}

// --- Health check ---
async function fetchHealth() {
  try {
    const h = await api('GET', '/health');
    document.getElementById('queue-size').textContent = h.queue_size;
  } catch {}
}

// --- Settings ---
async function loadSettings() {
  try {
    const s = await api('GET', '/api/settings');
    S.settings = s;
    document.getElementById('set-api-key').value = '';
    document.getElementById('set-api-key-mask').textContent = s.openai_api_key || 'not set';
    document.getElementById('set-serper-key').value = '';
    document.getElementById('set-serper-key-mask').textContent = s.serper_api_key || 'not set';
    document.getElementById('set-validation-model').value = s.validation_model || '';
    document.getElementById('set-boundary-model').value = s.boundary_model || '';
    document.getElementById('set-verification-model').value = s.verification_model || '';
    document.getElementById('set-default-zoom').value = s.default_zoom || '';
    document.getElementById('set-buffer').value = s.default_buffer_m || '';
    document.getElementById('set-overview-zoom').value = s.overview_zoom || '';
    document.getElementById('set-validation-prompt').value = s.validation_prompt || '';
    document.getElementById('set-boundary-prompt').value = s.boundary_prompt || '';
    document.getElementById('set-verification-prompt').value = s.verification_prompt || '';
    document.getElementById('set-correction-mode').value = s.correction_mode || 'v1';
    document.getElementById('set-verification-correction-prompt').value = s.verification_correction_prompt || '';
    document.getElementById('set-bbox-validation').checked = (s.bbox_validation_enabled || 'true') === 'true';
    // Bin detection
    document.getElementById('set-bin-detection-enabled').checked = (s.bin_detection_enabled || 'false') === 'true';
    document.getElementById('set-bin-detection-model').value = s.bin_detection_model || '';
    document.getElementById('set-bin-max-chunk').value = s.bin_detection_max_chunk_m || '';
    document.getElementById('set-bin-min-confidence').value = s.bin_detection_min_confidence || '50';
    document.getElementById('set-bin-delete-final').checked = (s.bin_delete_final_image || 'false') === 'true';
    document.getElementById('set-bin-resize-final').checked = (s.bin_resize_final_image || 'false') === 'true';
    document.getElementById('set-bin-reasoning').checked = (s.bin_detection_reasoning || 'true') === 'true';
    document.getElementById('set-bin-detection-prompt').value = s.bin_detection_prompt || '';
    // Performance
    document.getElementById('set-tile-delay').value = s.tile_delay_s || '';
    document.getElementById('set-tile-concurrency').value = s.tile_concurrency || '';
    document.getElementById('set-max-image-mb').value = s.max_image_mb || '';
    document.getElementById('set-duckdb-memory').value = s.duckdb_memory_limit || '';
    document.getElementById('set-duckdb-threads').value = s.duckdb_threads || '';
    // Infrastructure
    document.getElementById('set-worker-concurrency').value = s.worker_concurrency || '';
    document.getElementById('set-heavy-concurrency').value = s.heavy_phase_concurrency || '';
    document.getElementById('set-browser-concurrency').value = s.browser_concurrency || '';
    document.getElementById('set-stale-timeout').value = s.stale_scan_timeout_minutes || '';
  } catch {}
}

async function resetPrompt(type) {
  const key = type + '_prompt';
  try {
    await api('PUT', '/api/settings', { [key]: '' });
    toast('Prompt reset to default');
    loadSettings();
  } catch (e) {
    toast('Failed: ' + e.message, 'error');
  }
}

async function saveSettings(e) {
  e.preventDefault();
  const body = {};
  const key = document.getElementById('set-api-key').value.trim();
  if (key) body.openai_api_key = key;
  const sk = document.getElementById('set-serper-key').value.trim();
  if (sk) body.serper_api_key = sk;
  const vm = document.getElementById('set-validation-model').value.trim();
  if (vm) body.validation_model = vm;
  const bm = document.getElementById('set-boundary-model').value.trim();
  if (bm) body.boundary_model = bm;
  const vfm = document.getElementById('set-verification-model').value.trim();
  if (vfm) body.verification_model = vfm;
  const dz = document.getElementById('set-default-zoom').value.trim();
  if (dz) body.default_zoom = dz;
  const buf = document.getElementById('set-buffer').value.trim();
  if (buf) body.default_buffer_m = buf;
  const oz = document.getElementById('set-overview-zoom').value.trim();
  if (oz) body.overview_zoom = oz;
  const vp = document.getElementById('set-validation-prompt').value.trim();
  if (vp) body.validation_prompt = vp;
  const bp = document.getElementById('set-boundary-prompt').value.trim();
  if (bp) body.boundary_prompt = bp;
  const vfp = document.getElementById('set-verification-prompt').value.trim();
  if (vfp) body.verification_prompt = vfp;
  const cm = document.getElementById('set-correction-mode').value.trim();
  if (cm) body.correction_mode = cm;
  const vcp = document.getElementById('set-verification-correction-prompt').value.trim();
  if (vcp) body.verification_correction_prompt = vcp;
  body.bbox_validation_enabled = document.getElementById('set-bbox-validation').checked ? 'true' : 'false';
  // Bin detection
  body.bin_detection_enabled = document.getElementById('set-bin-detection-enabled').checked ? 'true' : 'false';
  const bdm = document.getElementById('set-bin-detection-model').value.trim();
  if (bdm) body.bin_detection_model = bdm;
  const bmc = document.getElementById('set-bin-max-chunk').value.trim();
  if (bmc) body.bin_detection_max_chunk_m = bmc;
  const bmnc = document.getElementById('set-bin-min-confidence').value.trim();
  if (bmnc) body.bin_detection_min_confidence = bmnc;
  body.bin_delete_final_image = document.getElementById('set-bin-delete-final').checked ? 'true' : 'false';
  body.bin_resize_final_image = document.getElementById('set-bin-resize-final').checked ? 'true' : 'false';
  body.bin_detection_reasoning = document.getElementById('set-bin-reasoning').checked ? 'true' : 'false';
  const bdp = document.getElementById('set-bin-detection-prompt').value.trim();
  if (bdp) body.bin_detection_prompt = bdp;
  // Performance
  const td = document.getElementById('set-tile-delay').value.trim();
  if (td) body.tile_delay_s = td;
  const tc = document.getElementById('set-tile-concurrency').value.trim();
  if (tc) body.tile_concurrency = tc;
  const mim = document.getElementById('set-max-image-mb').value.trim();
  if (mim) body.max_image_mb = mim;
  const dml = document.getElementById('set-duckdb-memory').value.trim();
  if (dml) body.duckdb_memory_limit = dml;
  const dt = document.getElementById('set-duckdb-threads').value.trim();
  if (dt) body.duckdb_threads = dt;
  // Infrastructure
  const wc = document.getElementById('set-worker-concurrency').value.trim();
  if (wc) body.worker_concurrency = wc;
  const hc = document.getElementById('set-heavy-concurrency').value.trim();
  if (hc) body.heavy_phase_concurrency = hc;
  const bc = document.getElementById('set-browser-concurrency').value.trim();
  if (bc) body.browser_concurrency = bc;
  const st = document.getElementById('set-stale-timeout').value.trim();
  if (st) body.stale_scan_timeout_minutes = st;

  if (Object.keys(body).length === 0) {
    toast('No changes to save', 'error');
    return;
  }

  try {
    await api('PUT', '/api/settings', body);
    toast('Settings saved');
    loadSettings();
  } catch (e) {
    toast('Failed: ' + e.message, 'error');
  }
}

// --- Geocoding ---
function parseGoogleMapsUrl(str) {
  // Prefer exact place pin (!3d<lat>!4d<lng>) over viewport center (@lat,lng)
  const placeMatch = str.match(/!3d(-?\d+\.?\d*)!4d(-?\d+\.?\d*)/);
  if (placeMatch) {
    const lat = parseFloat(placeMatch[1]);
    const lng = parseFloat(placeMatch[2]);
    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180)
      return { lat, lng };
  }
  // Fallback to viewport center
  const match = str.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
  if (!match) return null;
  const lat = parseFloat(match[1]);
  const lng = parseFloat(match[2]);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
  return { lat, lng };
}

function parseRawCoords(str) {
  const match = str.trim().match(/^(-?\d+\.?\d*)\s*[,\s]\s*(-?\d+\.?\d*)$/);
  if (!match) return null;
  const lat = parseFloat(match[1]);
  const lng = parseFloat(match[2]);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return null;
  return { lat, lng };
}

// --- Geocoder helpers (each returns [] on failure, never throws) ---

function fetchSerper(facilityName, address) {
  if (!facilityName && !address) return Promise.resolve([]);
  const params = new URLSearchParams();
  if (facilityName) params.set('name', facilityName);
  if (address) params.set('address', address);
  return fetch(`/api/geocode/serper?${params}`)
    .then(r => r.ok ? r.json() : { results: [] })
    .then(data => (data.results || []).map(r => ({
      lat: r.lat, lng: r.lng, display_name: r.display_name, source: 'serper',
    })))
    .catch(() => []);
}

function fetchGoogle(facilityName, address) {
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 25000); // hard ceiling
  const params = new URLSearchParams({ name: facilityName, address });
  return fetch(`/api/geocode/google-search?${params}`, { signal: controller.signal })
    .then(r => r.ok ? r.json() : { results: [] })
    .then(data => (data.results || []).map(r => ({
      lat: r.lat, lng: r.lng, display_name: r.display_name, source: 'google',
    })))
    .catch(e => {
      if (e.name === 'AbortError') console.warn('Google Maps geocode timed out after 25s');
      else console.warn('Google Maps geocode failed:', e);
      return [];
    })
    .finally(() => clearTimeout(timer));
}

function fetchCensus(address) {
  return fetch(`/api/geocode/census?address=${encodeURIComponent(address)}`)
    .then(r => r.ok ? r.json() : null)
    .then(data => {
      const matches = data?.result?.addressMatches;
      if (!matches || matches.length === 0) return [];
      return matches.map(m => ({
        lat: m.coordinates.y, lng: m.coordinates.x, display_name: m.matchedAddress, source: 'census',
      }));
    })
    .catch(() => []);
}

async function geocodeAddress(str, facilityName = '') {
  // Step 1: Try Serper Maps (retry + fuzzy match built in)
  const serper = await fetchSerper(facilityName, str);
  if (serper.length > 0) {
    const census = await Promise.race([
      fetchCensus(str),
      new Promise(resolve => setTimeout(() => resolve([]), 3000)),
    ]);
    return [...serper, ...census];
  }

  // Step 2: Census fallback
  const googleP = facilityName ? fetchGoogle(facilityName, str) : Promise.resolve([]);
  const census = await fetchCensus(str);
  if (census.length > 0) {
    const google = await Promise.race([
      googleP,
      new Promise(resolve => setTimeout(() => resolve([]), 8000)),
    ]);
    if (google.length > 0) return google;
    return census;
  }

  // Step 3: Google Maps headless fallback
  const google = await googleP;
  if (google.length > 0) return google;
  throw new Error('No results found for this address');
}


async function resolveLocation(input) {
  const trimmed = input.trim();
  if (!trimmed) throw new Error('Please enter an address, coordinates, or Google Maps URL');

  // 1. Google Maps URL
  if (trimmed.includes('google.com/maps') || trimmed.includes('goo.gl/maps')) {
    const coords = parseGoogleMapsUrl(trimmed);
    if (coords) return { ...coords, display_name: 'Extracted from Google Maps URL', source: 'google_maps' };
    throw new Error('Could not extract coordinates from Google Maps URL');
  }

  // 2. Raw coordinates
  const rawCoords = parseRawCoords(trimmed);
  if (rawCoords) return { ...rawCoords, display_name: `Raw coordinates`, source: 'raw_coords' };

  // 3. Address geocoding (Serper → Census → Google)
  const facilityName = document.getElementById('sf-name')?.value?.trim() || '';
  const results = await geocodeAddress(trimmed, facilityName);
  return { ...results[0], alternatives: results.slice(1) };
}

function _sourceBadge(source) {
  const badges = {
    serper:      '<span class="inline-block text-[10px] font-semibold px-1.5 py-0.5 rounded bg-emerald-700/60 text-emerald-200">Serper</span>',
    google:      '<span class="inline-block text-[10px] font-semibold px-1.5 py-0.5 rounded bg-green-700/60 text-green-200">Google</span>',
    census:      '<span class="inline-block text-[10px] font-semibold px-1.5 py-0.5 rounded bg-blue-700/60 text-blue-200">Census</span>',
    google_maps: '<span class="inline-block text-[10px] font-semibold px-1.5 py-0.5 rounded bg-gray-600/60 text-gray-300">URL</span>',
    raw_coords:  '<span class="inline-block text-[10px] font-semibold px-1.5 py-0.5 rounded bg-gray-600/60 text-gray-300">Manual</span>',
  };
  return badges[source] || '';
}

function showResolveResult(result) {
  S.resolved = result;
  const container = document.getElementById('sf-resolve-result');
  const alternatives = result.alternatives || [];

  let html = `<div class="bg-gray-800/50 border border-gray-700 rounded px-3 py-2 text-sm space-y-1">
    <div class="flex items-center gap-2">
      <span class="text-green-400">&#10003;</span>
      <span class="text-gray-200 font-medium">${result.lat.toFixed(6)}, ${result.lng.toFixed(6)}</span>
      ${_sourceBadge(result.source)}
      <button type="button" onclick="showManualOverride()" class="text-xs text-blue-400 hover:text-blue-300 active:scale-95 ml-auto">Edit</button>
    </div>
    <div class="text-xs text-gray-400 truncate" title="${esc(result.display_name)}">${esc(result.display_name)}</div>`;

  if (alternatives.length > 0) {
    html += `<details class="mt-1"><summary class="text-xs text-gray-500 cursor-pointer hover:text-gray-300">Other results (${alternatives.length})</summary><div class="mt-1 space-y-1">`;
    alternatives.forEach((alt, i) => {
      html += `<div class="flex items-center gap-2 text-xs text-gray-400 hover:text-gray-200 cursor-pointer" onclick="pickAlternative(${i})">
        <span class="text-gray-600">&bull;</span>
        <span>${alt.lat.toFixed(6)}, ${alt.lng.toFixed(6)}</span>
        ${_sourceBadge(alt.source)}
        <span class="truncate text-gray-500">${esc(alt.display_name)}</span>
      </div>`;
    });
    html += '</div></details>';
  }

  html += '</div>';
  container.innerHTML = html;
  container.classList.remove('hidden');
  document.getElementById('sf-manual-override').classList.add('hidden');
  document.getElementById('sf-submit').disabled = false;
}

function pickAlternative(idx) {
  const alt = S.resolved.alternatives[idx];
  if (!alt) return;
  const oldAlts = [{ lat: S.resolved.lat, lng: S.resolved.lng, display_name: S.resolved.display_name, source: S.resolved.source },
    ...S.resolved.alternatives.filter((_, i) => i !== idx)];
  showResolveResult({ ...alt, alternatives: oldAlts });
}

function showResolveError(msg) {
  S.resolved = null;
  const container = document.getElementById('sf-resolve-result');
  container.innerHTML = `<div class="bg-red-900/30 border border-red-800 rounded px-3 py-2 text-sm flex items-center gap-2">
    <span class="text-red-400">&#10007;</span>
    <span class="text-red-300">${esc(msg)}</span>
    <button type="button" onclick="showManualOverride()" class="text-xs text-blue-400 hover:text-blue-300 active:scale-95 ml-auto">Enter manually</button>
  </div>`;
  container.classList.remove('hidden');
  document.getElementById('sf-submit').disabled = true;
}

function showManualOverride() {
  const override = document.getElementById('sf-manual-override');
  override.classList.remove('hidden');
  if (S.resolved) {
    document.getElementById('sf-lat').value = S.resolved.lat;
    document.getElementById('sf-lng').value = S.resolved.lng;
  }
}

function applyManualCoords() {
  const lat = parseFloat(document.getElementById('sf-lat').value);
  const lng = parseFloat(document.getElementById('sf-lng').value);
  if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
    toast('Invalid coordinates. Lat: -90 to 90, Lng: -180 to 180', 'error');
    return;
  }
  showResolveResult({ lat, lng, display_name: 'Manual entry', source: 'manual' });
}

function cancelManualOverride() {
  document.getElementById('sf-manual-override').classList.add('hidden');
}

async function handleResolve() {
  const input = document.getElementById('sf-location').value;
  const btn = document.getElementById('sf-resolve');
  btn.disabled = true;
  btn.textContent = 'Resolving...';
  try {
    const result = await resolveLocation(input);
    showResolveResult(result);
  } catch (err) {
    showResolveError(err.message);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Resolve';
  }
}

function resetResolveState() {
  S.resolved = null;
  document.getElementById('sf-resolve-result').classList.add('hidden');
  document.getElementById('sf-resolve-result').innerHTML = '';
  document.getElementById('sf-manual-override').classList.add('hidden');
  document.getElementById('sf-submit').disabled = true;
}

// --- Scan form ---
async function submitScan(e) {
  e.preventDefault();
  if (!S.resolved) {
    toast('Please resolve a location first', 'error');
    return;
  }

  const btn = document.getElementById('sf-submit');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  const body = {
    name: document.getElementById('sf-name').value.trim(),
    lat: S.resolved.lat,
    lng: S.resolved.lng,
  };
  const addr = document.getElementById('sf-location').value.trim();
  if (addr && S.resolved.source !== 'raw_coords') body.address = addr;

  try {
    await api('POST', '/api/scan', body);
    toast(`Scan queued for ${body.name}`);
    document.getElementById('scan-form').reset();
    resetResolveState();
    S.offset = 0;
    fetchScans();
    fetchHealth();
  } catch (err) {
    toast('Submit failed: ' + err.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Submit Scan';
  }
}

// --- Import modal ---
let importItems = [];  // shared items array for both paste & CSV

function openImportModal() {
  document.getElementById('import-modal').classList.remove('hidden');
  document.getElementById('import-textarea').value = '';
  document.getElementById('import-csv-input').value = '';
  document.getElementById('csv-upload-label').innerHTML = `
    <svg class="w-8 h-8 mb-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
    <p class="text-sm text-gray-400">Click to upload CSV</p>`;
  importItems = [];
  switchImportTab('paste');
  updateImportCount();
  document.getElementById('import-textarea').focus();
}

function closeImportModal() {
  document.getElementById('import-modal').classList.add('hidden');
  importItems = [];
}

function switchImportTab(tab) {
  const pasteBtn = document.getElementById('import-tab-paste');
  const csvBtn = document.getElementById('import-tab-csv');
  const pastePanel = document.getElementById('import-panel-paste');
  const csvPanel = document.getElementById('import-panel-csv');

  if (tab === 'paste') {
    pasteBtn.className = 'flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition bg-gray-700 text-white';
    csvBtn.className = 'flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition text-gray-400 hover:text-gray-200';
    pastePanel.classList.remove('hidden');
    csvPanel.classList.add('hidden');
  } else {
    csvBtn.className = 'flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition bg-gray-700 text-white';
    pasteBtn.className = 'flex-1 text-sm font-medium rounded-md px-3 py-1.5 transition text-gray-400 hover:text-gray-200';
    csvPanel.classList.remove('hidden');
    pastePanel.classList.add('hidden');
  }
  S._importTab = tab;
  updateImportCount();
}

function parseImportLines(text) {
  return text.split('\n')
    .map(line => line.trim())
    .filter(line => line.length > 0)
    .map(line => {
      const parts = line.split('\t');
      const name = (parts[0] || '').trim();
      const address = (parts[1] || '').trim() || null;
      const domain = (parts[2] || '').trim() || null;
      return { name, address, domain };
    })
    .filter(item => item.name.length > 0);
}

function parseCsvText(text) {
  // Parse CSV with support for quoted fields
  const lines = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQuotes && text[i + 1] === '"') { current += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (ch === '\n' && !inQuotes) {
      lines.push(current); current = '';
    } else if (ch === '\r' && !inQuotes) {
      // skip \r
    } else {
      current += ch;
    }
  }
  if (current.trim()) lines.push(current);

  if (lines.length === 0) return [];

  // Split each line into fields
  function splitCsvLine(line) {
    const fields = [];
    let field = '';
    let q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        if (q && line[i + 1] === '"') { field += '"'; i++; }
        else { q = !q; }
      } else if (ch === ',' && !q) {
        fields.push(field); field = '';
      } else {
        field += ch;
      }
    }
    fields.push(field);
    return fields.map(f => f.trim());
  }

  // Map headers case-insensitively
  const headerFields = splitCsvLine(lines[0]);
  const headerMap = {};
  headerFields.forEach((h, i) => { headerMap[h.toLowerCase().replace(/[^a-z]/g, '')] = i; });

  const nameIdx = headerMap['name'] ?? headerMap['companyname'] ?? headerMap['facilityname'] ?? 0;
  const addrIdx = headerMap['address'] ?? headerMap['addr'] ?? headerMap['facilityaddress'] ?? 1;
  const domainIdx = headerMap['domain'] ?? headerMap['website'] ?? headerMap['url'] ?? 2;

  // Check if first row looks like a header
  const firstVal = headerFields[nameIdx] || '';
  const isHeader = /^(name|company|facility)/i.test(firstVal);
  const startIdx = isHeader ? 1 : 0;

  const items = [];
  for (let i = startIdx; i < lines.length; i++) {
    const fields = splitCsvLine(lines[i]);
    const name = (fields[nameIdx] || '').trim();
    if (!name) continue;
    items.push({
      name,
      address: (fields[addrIdx] || '').trim() || null,
      domain: (fields[domainIdx] || '').trim() || null,
    });
  }
  return items;
}

function handleCsvFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    importItems = parseCsvText(ev.target.result);
    document.getElementById('csv-upload-label').innerHTML = `
      <svg class="w-6 h-6 mb-1 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
      <p class="text-sm text-gray-300">${esc(file.name)}</p>
      <p class="text-xs text-gray-500">${importItems.length} entries parsed</p>`;
    updateImportCount();
  };
  reader.readAsText(file);
}

function updateImportCount() {
  let count;
  if (S._importTab === 'csv') {
    count = importItems.length;
  } else {
    count = parseImportLines(document.getElementById('import-textarea').value).length;
  }
  document.getElementById('import-count').textContent = `${count} entr${count === 1 ? 'y' : 'ies'}`;
  document.getElementById('import-submit-btn').disabled = count === 0;
}

async function submitImport() {
  let items;
  if (S._importTab === 'csv') {
    items = importItems;
  } else {
    items = parseImportLines(document.getElementById('import-textarea').value);
  }
  if (items.length === 0) return;

  const btn = document.getElementById('import-submit-btn');
  btn.disabled = true;
  btn.textContent = 'Importing...';

  try {
    const res = await api('POST', '/api/scan/import', { facilities: items });
    toast(`Imported ${res.length} facilit${res.length === 1 ? 'y' : 'ies'}`);
    closeImportModal();
    S.offset = 0;
    fetchScans();
  } catch (e) {
    toast('Import failed: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Import';
  }
}

// --- Event listeners ---
document.addEventListener('DOMContentLoaded', () => {
  // Scan form
  document.getElementById('scan-form').addEventListener('submit', submitScan);
  document.getElementById('sf-resolve').addEventListener('click', handleResolve);
  document.getElementById('sf-location').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); handleResolve(); }
  });
  // Reset resolved state when location input changes
  document.getElementById('sf-location').addEventListener('input', () => {
    if (S.resolved) resetResolveState();
  });

  // Settings save
  document.getElementById('settings-form').addEventListener('submit', saveSettings);

  // Filters
  let searchTimer;
  document.getElementById('search-input').addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { S.offset = 0; fetchScans(); }, 300);
  });
  document.getElementById('filter-status').addEventListener('change', () => { S.offset = 0; fetchScans(); });
  document.getElementById('filter-bins').addEventListener('change', () => { S.offset = 0; fetchScans(); });

  // Group-by-company toggle (switch)
  document.getElementById('group-toggle').addEventListener('change', (e) => {
    S.groupByCompany = e.target.checked;
    document.getElementById('group-label-flat').classList.toggle('text-blue-400', !S.groupByCompany);
    document.getElementById('group-label-flat').classList.toggle('text-gray-500', S.groupByCompany);
    document.getElementById('group-label-grouped').classList.toggle('text-blue-400', S.groupByCompany);
    document.getElementById('group-label-grouped').classList.toggle('text-gray-500', !S.groupByCompany);
    if (S.groupByCompany) {
      // Collapse all groups by default when switching to grouped
      const allGroups = new Set(S.scans.map(s => (s.facility_name || '-').toLowerCase()));
      S.collapsedGroups = allGroups;
    }
    renderTable();
  });

  // Import modal
  document.getElementById('import-btn').addEventListener('click', openImportModal);
  document.getElementById('import-textarea').addEventListener('input', updateImportCount);
  document.getElementById('import-csv-input').addEventListener('change', handleCsvFile);

  // Select all checkbox
  document.getElementById('select-all').addEventListener('change', (e) => {
    const checked = e.target.checked;
    S.scans.forEach(s => {
      if (checked) S.selected.add(s.id);
      else S.selected.delete(s.id);
    });
    updateSelectionBtns();
    renderTable();
  });

  // Delete button
  document.getElementById('delete-btn').addEventListener('click', deleteSelected);
  document.getElementById('scan-selected-btn').addEventListener('click', scanSelected);
  document.getElementById('detect-bins-btn').addEventListener('click', detectBinsSelected);
  document.getElementById('scan-pending-btn').addEventListener('click', scanAllPending);

  // Refresh
  document.getElementById('refresh-btn').addEventListener('click', fetchScans);

  // Pagination
  document.getElementById('prev-btn').addEventListener('click', () => {
    S.offset = Math.max(0, S.offset - S.limit);
    fetchScans();
  });
  document.getElementById('next-btn').addEventListener('click', () => {
    S.offset += S.limit;
    fetchScans();
  });

  // Column sorting
  document.querySelectorAll('th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const field = th.dataset.sort;
      if (S.sortField === field) {
        S.sortDir = S.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        S.sortField = field;
        S.sortDir = 'asc';
      }
      document.querySelectorAll('th[data-sort]').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      th.classList.add(S.sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
      renderTable();
    });
  });

  // Router
  window.addEventListener('hashchange', handleHash);
  handleHash();

  // Health polling
  fetchHealth();
  setInterval(fetchHealth, 30000);

  // Eagerly load settings so rendering has access to current thresholds
  loadSettings();
});
</script>
</body>
</html>
